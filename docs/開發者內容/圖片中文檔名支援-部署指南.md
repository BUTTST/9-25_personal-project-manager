# 圖片中文檔名支援 - 部署指南

## 📋 變更概述

本次更新徹底解決了圖片中文檔名的支援問題，採用「資料庫表存儲檔名映射」方案。

### 核心變更

- ✅ 新增 `image_metadata` 資料庫表
- ✅ 修改所有圖片操作函數同步更新資料庫
- ✅ 從資料庫讀取顯示名稱（而非 Storage metadata）
- ✅ 提供數據遷移腳本

## 🚀 部署步驟

### 步驟 1：在 Supabase 創建資料表

1. 登入 [Supabase Dashboard](https://app.supabase.com/)
2. 選擇您的專案
3. 進入「SQL Editor」
4. 執行以下 SQL：

```sql
-- 複製 supabase/migrations/001_create_image_metadata.sql 的內容
-- 或直接在 Supabase Dashboard 執行
```

**SQL 檔案位置**: `supabase/migrations/001_create_image_metadata.sql`

### 步驟 2：遷移現有圖片數據

如果您已經有上傳的圖片，需要將它們的資訊遷移到新表：

```bash
# 確保環境變數已設定
# .env.local 應包含：
# - NEXT_PUBLIC_SUPABASE_URL
# - SUPABASE_SERVICE_ROLE_KEY

# 執行遷移腳本
node scripts/migrate-image-metadata.js
```

**預期輸出**:
```
🚀 開始遷移圖片元數據...
📂 步驟 1：讀取 Supabase Storage 中的圖片列表...
   找到 15 個圖片檔案
🔍 步驟 2：檢查資料庫中已有的記錄...
   資料庫中已有 0 筆記錄
📝 步驟 3：準備遷移數據...
   ✨ 找到中文檔名: 2025-10-17-145055-17z7h6.png → 螢幕擷取畫面 2025-10-17 145055.png
   準備插入 15 筆新記錄
💾 步驟 4：寫入資料庫...
   ✅ 已插入 15/15 筆記錄
✅ 遷移完成！
```

### 步驟 3：部署代碼

```bash
# 提交變更
git add .
git commit -m "feat: 使用資料庫表實現圖片中文檔名完整支援"
git push

# Vercel 會自動部署
```

### 步驟 4：驗證功能

1. **測試上傳中文檔名**
   - 進入管理後台 → 圖片管理
   - 上傳一張含中文檔名的圖片
   - 確認顯示正確

2. **測試編輯檔名**
   - 點擊圖片的「編輯」按鈕
   - 輸入中文檔名
   - 確認保存成功

3. **測試新增專案時選擇圖片**
   - 進入「新增專案」頁面
   - 在「選擇圖片」區塊
   - 確認顯示中文檔名 ✨

## 📊 資料庫表結構

### image_metadata 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| stored_filename | TEXT (PK) | 實際存儲的檔名（ASCII） |
| original_filename | TEXT | 顯示的檔名（可含中文） |
| file_size | BIGINT | 檔案大小（bytes） |
| content_type | TEXT | MIME 類型 |
| file_hash | TEXT | 檔案 hash（防重複） |
| created_at | TIMESTAMPTZ | 創建時間 |
| updated_at | TIMESTAMPTZ | 更新時間 |

### 索引

- `idx_image_metadata_original`: 原始檔名索引（加速搜尋）
- `idx_image_metadata_created`: 創建時間索引（排序）
- `idx_image_metadata_hash`: Hash 索引（防重複上傳）

### RLS 政策

- **SELECT**: 允許公開讀取（用於前端顯示）
- **INSERT/UPDATE/DELETE**: 僅透過後端 API（service_role）

## 🔄 數據流程

### 上傳圖片

```
用戶上傳「螢幕擷取畫面.png」
  ↓
存儲到 Storage：2025-10-30-103634-ggn7y0.png
  ↓
寫入資料庫：{
  stored_filename: "2025-10-30-103634-ggn7y0.png",
  original_filename: "螢幕擷取畫面.png"
}
  ↓
用戶看到：螢幕擷取畫面.png ✨
```

### 列出圖片

```
API 請求 GET /api/images
  ↓
查詢資料庫：SELECT * FROM image_metadata
  ↓
返回：[{
  name: "2025-10-30-103634-ggn7y0.png",
  originalFilename: "螢幕擷取畫面.png",
  url: "https://..."
}]
  ↓
前端顯示：螢幕擷取畫面.png ✨
```

### 編輯檔名

```
用戶編輯為「產品截圖.png」
  ↓
API 請求 POST /api/images/rename
  ↓
更新資料庫：UPDATE image_metadata 
  SET original_filename = '產品截圖.png'
  WHERE stored_filename = '2025-10-30-103634-ggn7y0.png'
  ↓
存儲檔名不變（URL 不變）
  ↓
用戶看到：產品截圖.png ✨
```

## 🧪 測試清單

- [ ] **資料表創建**
  - 在 Supabase Dashboard 確認 `image_metadata` 表已創建
  - 確認索引和觸發器正常

- [ ] **數據遷移**
  - 執行遷移腳本成功
  - 資料庫中有對應記錄
  - 中文檔名正確保存

- [ ] **上傳功能**
  - 上傳含中文檔名的圖片
  - 確認資料庫有新記錄
  - 顯示名稱正確

- [ ] **列表功能**
  - 圖片庫顯示中文檔名
  - 搜尋功能正常
  - 排序功能正常

- [ ] **編輯功能**
  - 編輯圖片檔名為中文
  - 確認資料庫已更新
  - 重新載入後顯示正確

- [ ] **刪除功能**
  - 刪除圖片
  - 確認資料庫記錄也被刪除

- [ ] **專案整合**
  - 新增專案時選擇圖片
  - 確認顯示中文檔名
  - 編輯專案時選擇圖片
  - 確認顯示中文檔名

## 🔧 故障排除

### 問題 1：資料表創建失敗

**症狀**: SQL 執行時報錯

**解決方案**:
1. 確認您有管理員權限
2. 檢查是否已存在同名表（先刪除舊表）
3. 逐段執行 SQL（先創建表，再創建索引）

### 問題 2：遷移腳本失敗

**症狀**: `node scripts/migrate-image-metadata.js` 執行失敗

**解決方案**:
1. 確認 `.env.local` 包含正確的環境變數
2. 確認資料表已創建
3. 檢查網絡連線
4. 查看詳細錯誤訊息

### 問題 3：仍然顯示存儲檔名

**症狀**: 前端顯示 `2025-10-30-103634-ggn7y0.png` 而非中文檔名

**可能原因**:
1. 資料庫記錄缺失（未執行遷移）
2. 代碼未部署成功
3. 瀏覽器緩存

**解決方案**:
1. 重新執行遷移腳本
2. 確認 Vercel 部署成功
3. 清除瀏覽器緩存並刷新
4. 檢查瀏覽器控制台是否有錯誤

### 問題 4：上傳後資料庫無記錄

**症狀**: 上傳成功，但資料庫中找不到記錄

**解決方案**:
1. 檢查後端日誌（Vercel Dashboard → Functions → Logs）
2. 確認 `SUPABASE_SERVICE_ROLE_KEY` 正確
3. 確認 RLS 政策未阻擋 service_role

## 📚 相關文件

- [圖片中文檔名支援實現說明](./圖片中文檔名支援實現說明.md)
- [資料庫安全性迭代](./資料庫安全性迭代.md)
- [Supabase Storage 文件](https://supabase.com/docs/guides/storage)
- [Supabase Database 文件](https://supabase.com/docs/guides/database)

## 💡 注意事項

1. **向後相容**: 舊的圖片（沒有資料庫記錄）會在遷移腳本執行後正常顯示

2. **數據一致性**: 所有圖片操作都會同步更新 Storage 和資料庫

3. **效能**: 從資料庫讀取比從 Storage metadata 讀取更快

4. **可擴展性**: 未來可以在 `image_metadata` 表添加更多欄位（標籤、分類等）

---

**部署日期**: 2025-10-30  
**版本**: v2.0  
**狀態**: ✅ 已完成

