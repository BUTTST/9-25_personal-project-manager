# 圖片中文檔名支援實現說明

> ⚠️ **版本更新**：此文件描述的是 v1.0 方案（使用 Storage metadata）  
> 新版本 v2.0 已改用資料庫表方案，請參閱 [部署指南](./圖片中文檔名支援-部署指南.md)

## 📋 實現日期
2025-10-30（v1.0）  
2025-10-30（v2.0 - 資料庫表方案）

## 🎯 需求概述

管理員在後台需要能夠：
1. **上傳**含中文檔名的圖片，並保留顯示名稱
2. **編輯**圖片檔名為中文名稱
3. **顯示**時優先顯示中文檔名

## 🏗️ 技術架構

### 雙層檔名設計

本系統採用「雙層檔名架構」：

1. **存儲檔名（storedFilename）**
   - 實際存儲在 Supabase Storage 中
   - 格式：`{清理後的名稱}-{hash}.{ext}`
   - 特點：只包含 ASCII 字符，避免相容性問題
   - 範例：`2025-10-30-103634-ggn7y0.png`

2. **顯示檔名（originalFilename）**
   - 用戶看到的名稱
   - 存儲位置：Supabase Storage 的 `metadata.originalFilename`
   - 特點：可包含中文和特殊字符
   - 範例：`螢幕擷取畫面 2025-10-30 103634.png`

### 優勢

✅ **相容性**：Supabase Storage 使用 ASCII 檔名，避免編碼問題  
✅ **用戶體驗**：管理員可以使用中文檔名  
✅ **穩定性**：URL 不變，專案引用不受影響  
✅ **擴展性**：支持兩種重命名模式

## 📦 實現細節

### 1. 上傳功能（已有，無需修改）

**檔案**：`app/lib/storage.ts` - `uploadImage()`

**流程**：
```typescript
上傳「螢幕擷取畫面 2025-10-30 103634.png」
  ↓ 生成 hash（ggn7y0）
  ↓ 清理檔名（移除中文）→ 2025-10-30-103634
  ↓ 組合 → 2025-10-30-103634-ggn7y0.png
  ↓ 存儲到 metadata.originalFilename：「螢幕擷取畫面 2025-10-30 103634.png」
```

**結果**：
- 存儲檔名：`2025-10-30-103634-ggn7y0.png`
- 顯示檔名：`螢幕擷取畫面 2025-10-30 103634.png` ✨

### 2. 重命名功能（新增/改進）

**檔案**：`app/lib/storage.ts`

#### 模式 A：僅更新顯示名稱（推薦）⭐

**函數**：`updateImageDisplayName()`

**特點**：
- 只更新 `metadata.originalFilename`
- 存儲檔名不變，URL 不變
- 無需更新專案引用
- **支持中文檔名** ✨

**流程**：
```typescript
存儲檔名：2025-10-30-103634-ggn7y0.png
  ↓ 用戶編輯為：「產品截圖-首頁設計.png」
  ↓ 下載檔案
  ↓ 刪除舊檔案
  ↓ 以相同檔名重新上傳，更新 metadata
  ↓ metadata.originalFilename = 「產品截圖-首頁設計.png」
```

**結果**：
- 存儲檔名：`2025-10-30-103634-ggn7y0.png`（不變）
- 顯示檔名：`產品截圖-首頁設計.png`（已更新）✨
- URL：不變
- 專案引用：無需更新

#### 模式 B：完整重命名

**函數**：`renameImage()`

**特點**：
- 改變存儲檔名和顯示檔名
- URL 改變，需更新專案引用
- 適用於需要重新整理檔案結構的場景

**流程**：
```typescript
舊檔名：2025-10-30-103634-ggn7y0.png
  ↓ 用戶重命名為：「新產品截圖.png」
  ↓ 生成新 hash
  ↓ 清理檔名 → image-{timestamp}.png
  ↓ 組合 → image-1730256000-abc123.png
  ↓ 更新所有專案引用
```

### 3. API 路由（已更新）

**檔案**：`app/api/images/rename/route.ts`

**請求參數**：
```typescript
{
  oldFilename: string,        // 存儲檔名
  newFilename: string,        // 新檔名（可含中文）
  renameMode?: 'display-only' | 'full', // 預設 'display-only'
  updateReferences?: boolean  // 預設 true
}
```

**回應**：
```typescript
{
  success: true,
  mode: 'display-only',
  newFilename: '2025-10-30-103634-ggn7y0.png', // 存儲檔名
  newDisplayName: '產品截圖-首頁設計.png',      // 顯示檔名
  referencesFound: 0,
  projectsUpdated: 0
}
```

### 4. 前端元件（已更新）

**檔案**：`app/components/admin/ImageGallery.tsx`

**修改內容**：
- `saveRename()` 函數預設使用 `renameMode: 'display-only'`
- 支持中文輸入
- 提示訊息更清晰

**使用體驗**：
```
用戶點擊「編輯」按鈕
  ↓ 輸入框顯示當前的顯示檔名（可能含中文）
  ↓ 用戶輸入新的中文檔名
  ↓ 點擊「保存」
  ↓ 成功！提示「新顯示名稱：{中文檔名}」
```

## 🧪 測試清單

### 功能測試

- [ ] **上傳中文檔名圖片**
  - 上傳「螢幕擷取畫面.png」
  - 確認顯示為「螢幕擷取畫面.png」
  - 確認存儲檔名為 ASCII（例如：`-ggn7y0.png`）

- [ ] **編輯為中文檔名**
  - 選擇一張圖片，點擊編輯
  - 輸入「產品截圖-首頁設計.png」
  - 確認保存成功
  - 重新載入頁面，確認顯示中文檔名

- [ ] **搜尋功能**
  - 使用中文關鍵字搜尋
  - 確認能找到對應圖片

- [ ] **專案引用**
  - 編輯圖片檔名（display-only 模式）
  - 確認專案中的圖片仍正常顯示（URL 不變）

### 邊界測試

- [ ] 特殊字符：`圖片@#$%測試.png`
- [ ] 超長檔名：50+ 字元的中文檔名
- [ ] 空白檔名處理
- [ ] 重複檔名處理

## 📊 影響範圍

### 修改的檔案

1. `app/lib/storage.ts`
   - 新增：`updateImageDisplayName()`
   - 改進：`renameImage()`（保留 metadata）

2. `app/api/images/rename/route.ts`
   - 新增：雙模式支持（display-only / full）
   - 改進：更詳細的回應資訊

3. `app/components/admin/ImageGallery.tsx`
   - 修改：`saveRename()` 預設使用 display-only 模式
   - 改進：更友善的提示訊息

### 未修改的檔案（功能已完善）

- `app/api/images/route.ts` - 上傳功能已正確保存 metadata ✅
- `app/components/admin/ImageUploader.tsx` - 顯示邏輯已完善 ✅

## 🔄 向後相容性

✅ **完全相容**：
- 舊有圖片（沒有 originalFilename）仍正常顯示
- 現有專案引用不受影響
- API 參數保持向後相容（renameMode 預設值）

## 📝 使用指南

### 管理員操作步驟

#### 上傳含中文檔名的圖片

1. 進入「管理後台」→「圖片管理」
2. 拖拽或選擇檔案（可含中文檔名）
3. 點擊「開始上傳」
4. ✅ 完成！圖片列表顯示中文檔名

#### 編輯圖片檔名為中文

1. 在圖片庫中，hover 到圖片上
2. 點擊「鉛筆」圖示（編輯）
3. 輸入新的中文檔名
4. 點擊「保存」
5. ✅ 完成！顯示名稱已更新

## 🎉 預期效果

### 上傳體驗
```
用戶上傳：螢幕擷取畫面 2025-10-30 103634.png
存儲為：2025-10-30-103634-ggn7y0.png
顯示為：螢幕擷取畫面 2025-10-30 103634.png ✨
```

### 編輯體驗
```
用戶看到：螢幕擷取畫面 2025-10-30 103634.png
編輯為：產品截圖-首頁設計.png ✏️
顯示為：產品截圖-首頁設計.png ✨
存儲檔名：2025-10-30-103634-ggn7y0.png（不變）
專案引用：不需更新（URL 不變）
```

## 🚀 未來擴展

### 可選改進

1. **批量重命名**
   - 支持同時編輯多個圖片的顯示名稱
   
2. **檔名模板**
   - 提供檔名格式化模板（例如：`{date}-{category}-{index}`）

3. **檔名建議**
   - 根據圖片內容自動建議中文檔名

4. **歷史記錄**
   - 記錄檔名修改歷史，支持還原

## 🔗 相關文件

- [資料庫安全性迭代](./資料庫安全性迭代.md)
- [新增圖片快速指南](../快速指南/新增圖片_快速指南.md)
- [Supabase Storage 文件](https://supabase.com/docs/guides/storage)

---

**實現者**：AI Assistant  
**審核狀態**：待測試  
**最後更新**：2025-10-30

