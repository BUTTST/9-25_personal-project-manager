---
globs: "app/lib/**/*.ts,app/api/**/*.ts,app/api/**/route.ts"
---
# è³‡æ–™å®‰å…¨èˆ‡é˜²è­·è¦å‰‡ï¼ˆSupabase ç‰ˆï¼‰

> âš ï¸ **é‡è¦**ï¼šæœ¬è¦å‰‡çš„å„ªå…ˆç´šæœ€é«˜ï¼Œé•åä»»ä½•è¦å‰‡éƒ½å¯èƒ½å°è‡´ç”Ÿç”¢è³‡æ–™æ°¸ä¹…ä¸Ÿå¤±ï¼
> ğŸ“… æ›´æ–°æ—¥æœŸï¼š2025-10-28 - å·²é·ç§»è‡³ Supabase PostgreSQL + Storage

## ğŸš¨ æ ¸å¿ƒå®‰å…¨åŸå‰‡ï¼ˆçµ•ä¸å¦¥å”ï¼‰

### åŸå‰‡ 1ï¼šæ°¸ä¸è‡ªå‹•è¦†å¯«ç”Ÿç”¢è³‡æ–™
**ç¦æ­¢**ï¼šä»»ä½•åœ¨å…¨åŸŸç¯„åœã€è‡ªå‹•åŸ·è¡Œã€æˆ–é è¨­å•Ÿå‹•æ™‚å¯èƒ½è¦†å¯«ç¾æœ‰è³‡æ–™çš„é‚è¼¯ã€‚

âŒ **åš´ç¦æ¨¡å¼**ï¼š
```typescript
// ç¦æ­¢ï¼šåœ¨ GET ç«¯é»ä¸­è‡ªå‹•åˆå§‹åŒ–
export async function GET() {
  const { data: projects } = await supabaseAdmin.from('projects').select('*');
  if (!projects || projects.length === 0) {
    // â›” çµ•å°ç¦æ­¢è‡ªå‹•æ’å…¥ç¯„ä¾‹è³‡æ–™ï¼
    await supabaseAdmin.from('projects').insert(sampleProjects);
  }
}

// ç¦æ­¢ï¼šåœ¨æ‡‰ç”¨å•Ÿå‹•æ™‚è‡ªå‹•è¦†å¯«
if (!existingData || existingData.length === 0) {
  await supabaseAdmin.from('projects').delete().neq('id', ''); // â›” å±éšªï¼
  await supabaseAdmin.from('projects').insert(defaultData); // â›” å±éšªï¼
}

// ç¦æ­¢ï¼šç„¡æ¢ä»¶åˆªé™¤/æ›´æ–°
await supabaseAdmin.from('projects').delete(); // â›” æ²’æœ‰ WHERE æ¢ä»¶
```

âœ… **æ­£ç¢ºæ¨¡å¼**ï¼š
```typescript
// æ­£ç¢ºï¼šéœ€è¦ç®¡ç†å“¡æˆæ¬Šçš„æ‰‹å‹•åˆå§‹åŒ–
export async function POST(request: NextRequest) {
  const password = request.headers.get('x-admin-password');
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
  }
  
  // æ˜ç¢ºçš„ç”¨æˆ¶æ“ä½œï¼Œæœ‰æ—¥èªŒè¨˜éŒ„
  console.log('âš ï¸ ç®¡ç†å“¡è§¸ç™¼æ‰‹å‹•åˆå§‹åŒ–');
  
  // ä½¿ç”¨äº‹å‹™ç¢ºä¿åŸå­æ€§
  const { data, error } = await supabaseAdmin
    .from('projects')
    .insert(sampleProjects);
    
  if (error) {
    console.error('åˆå§‹åŒ–å¤±æ•—:', error);
    return NextResponse.json({ error: 'åˆå§‹åŒ–å¤±æ•—' }, { status: 500 });
  }
  
  return NextResponse.json({ success: true });
}
```

### åŸå‰‡ 2ï¼šè®€å–å¤±æ•—ä¸ç­‰æ–¼è³‡æ–™ç‚ºç©º
**ç¦æ­¢**ï¼šå°‡è®€å–éŒ¯èª¤éœé»˜è™•ç†ç‚ºç©ºè³‡æ–™ï¼Œé€²è€Œè§¸ç™¼åˆå§‹åŒ–ã€‚

âŒ **åš´ç¦æ¨¡å¼**ï¼š
```typescript
// ç¦æ­¢ï¼šå°‡è®€å–å¤±æ•—ç•¶ä½œç©ºè³‡æ–™
async function getProjects() {
  try {
    const { data } = await supabaseAdmin.from('projects').select('*');
    return data || []; // â›” å±éšªï¼šerror æ™‚ä¹Ÿè¿”å›ç©ºé™£åˆ—
  } catch (error) {
    return []; // â›” å±éšªï¼šå¯èƒ½èª¤åˆ¤ç‚ºé¦–æ¬¡éƒ¨ç½²
  }
}

// ç¦æ­¢ï¼šéœé»˜å¤±æ•—
const projects = await getProjects();
if (projects.length === 0) {
  // å¯èƒ½æ˜¯è®€å–å¤±æ•—ï¼Œä¸æ˜¯çœŸçš„ç‚ºç©ºï¼
  await initializeData(); // â›” ä¸å®‰å…¨
}
```

âœ… **æ­£ç¢ºæ¨¡å¼ï¼ˆSupabase ç‰ˆæœ¬ï¼‰**ï¼š
```typescript
// æ­£ç¢ºï¼šå€åˆ†éŒ¯èª¤å’Œç©ºè³‡æ–™
export async function getProjects() {
  if (!supabaseAdmin) {
    throw new Error('Supabase admin client not available');
  }
  
  const { data, error } = await supabaseAdmin
    .from('projects')
    .select('*')
    .order('sort_order');
  
  // æ˜ç¢ºè™•ç†éŒ¯èª¤
  if (error) {
    console.error('Database query failed:', error);
    throw new Error(`Failed to fetch projects: ${error.message}`);
  }
  
  // data ç‚º null æˆ– [] éƒ½æ˜¯åˆæ³•çš„ï¼ˆçœŸæ­£çš„ç©ºè³‡æ–™ï¼‰
  return data || [];
}

// ä½¿ç”¨æ™‚è™•ç†ç•°å¸¸
try {
  const projects = await getProjects();
  // é€™è£¡çš„ projects.length === 0 æ˜¯çœŸæ­£çš„ç©ºè³‡æ–™
} catch (error) {
  // é€™æ‰æ˜¯è®€å–å¤±æ•—ï¼Œä¸æ‡‰è§¸ç™¼åˆå§‹åŒ–
  console.error('Cannot read projects:', error);
  return NextResponse.json({ error: 'æš«æ™‚ç„¡æ³•è®€å–è³‡æ–™' }, { status: 503 });
}
```

### åŸå‰‡ 3ï¼šä½¿ç”¨è³‡æ–™åº«å±¤ç´šä¿è­·
**å¿…é ˆ**ï¼šåˆ©ç”¨ Supabase çš„å…§å»ºå®‰å…¨æ©Ÿåˆ¶ï¼Œè€Œéæ‰‹å‹•é©—è­‰ã€‚

âœ… **Supabase å®‰å…¨æ©Ÿåˆ¶**ï¼š
```typescript
// âœ… ä½¿ç”¨ PostgreSQL Constraints ä¿è­·è³‡æ–™å®Œæ•´æ€§
// åœ¨è³‡æ–™è¡¨å»ºç«‹æ™‚è¨­å®šï¼š
// - NOT NULL ç´„æŸï¼ˆå¿…å¡«æ¬„ä½ï¼‰
// - CHECK ç´„æŸï¼ˆå€¼ç¯„åœé©—è­‰ï¼‰
// - UNIQUE ç´„æŸï¼ˆé˜²æ­¢é‡è¤‡ï¼‰
// - FOREIGN KEY ç´„æŸï¼ˆé—œè¯å®Œæ•´æ€§ï¼‰

// âœ… ä½¿ç”¨ Row Level Security (RLS) æ§åˆ¶å­˜å–
// projects è¡¨çš„ RLS æ”¿ç­–ï¼š
// - SELECT: å…è¨±å…¬é–‹è®€å–ï¼ˆWHERE hidden = falseï¼‰
// - INSERT/UPDATE/DELETE: åƒ…å¾Œç«¯ service_role å¯æ“ä½œ

// API è·¯ç”±ä¸­çš„æ­£ç¢ºæ¨¡å¼ï¼š
export async function POST(request: NextRequest) {
  // ç¬¬ä¸€å±¤ï¼šé©—è­‰ç®¡ç†å“¡æ¬Šé™
  const password = request.headers.get('x-admin-password');
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
  }

  // ç¬¬äºŒå±¤ï¼šé©—è­‰ Supabase admin client
  if (!supabaseAdmin) {
    return NextResponse.json({ error: 'Database not available' }, { status: 503 });
  }

  // ç¬¬ä¸‰å±¤ï¼šé©—è­‰è¼¸å…¥è³‡æ–™
  const body = await request.json();
  if (!body.dateAndFileName || !body.description) {
    return NextResponse.json({ error: 'å¿…å¡«æ¬„ä½ç¼ºå¤±' }, { status: 400 });
  }

  // ç¬¬å››å±¤ï¼šåŸ·è¡Œè³‡æ–™åº«æ“ä½œï¼ˆPostgreSQL æœƒè‡ªå‹•é©—è­‰ constraintsï¼‰
  const { data, error } = await supabaseAdmin
    .from('projects')
    .insert({
      date_and_file_name: body.dateAndFileName,
      description: body.description,
      // ... å…¶ä»–æ¬„ä½
    })
    .select()
    .single();

  // ç¬¬äº”å±¤ï¼šè™•ç†è³‡æ–™åº«éŒ¯èª¤
  if (error) {
    console.error('Database insert failed:', error);
    // PostgreSQL éŒ¯èª¤ç¢¼æä¾›è©³ç´°è³‡è¨Š
    if (error.code === '23505') { // unique_violation
      return NextResponse.json({ error: 'å°ˆæ¡ˆå·²å­˜åœ¨' }, { status: 409 });
    }
    return NextResponse.json({ error: 'æ–°å¢å¤±æ•—' }, { status: 500 });
  }

  // è¨˜éŒ„æ“ä½œæ—¥èªŒ
  console.log('âœ… æ–°å¢å°ˆæ¡ˆæˆåŠŸ:', data.id);
  
  return NextResponse.json(data, { status: 201 });
}
```

## ğŸ”’ API ç«¯é»å®‰å…¨è¦ç¯„

### è¦ç¯„ 1ï¼šæ‰€æœ‰å¯«å…¥ç«¯é»éƒ½éœ€è¦é©—è­‰
```typescript
// âœ… æ­£ç¢ºï¼šæ¯å€‹ä¿®æ”¹è³‡æ–™çš„ç«¯é»éƒ½è¦é©—è­‰
export async function POST(request: NextRequest) {
  // å¿…é ˆï¼šé©—è­‰ç®¡ç†å“¡æ¬Šé™
  const password = request.headers.get('x-admin-password');
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: 'æœªæˆæ¬Šè¨ªå•' }, { status: 401 });
  }
  
  // ç¹¼çºŒè™•ç†...
}
```

### è¦ç¯„ 2ï¼šå±éšªæ“ä½œå¿…é ˆæ˜¯ POSTï¼Œä¸èƒ½æ˜¯ GET
```typescript
// âŒ ç¦æ­¢ï¼šGET è«‹æ±‚ä¸­ä¿®æ”¹è³‡æ–™
export async function GET() {
  await writeProjectData(data); // â›” GET ä¸æ‡‰è©²æœ‰å‰¯ä½œç”¨
}

// âœ… æ­£ç¢ºï¼šä½¿ç”¨ POST é€²è¡Œå¯«å…¥æ“ä½œ
export async function POST(request: NextRequest) {
  // é©—è­‰ â†’ è®€å– â†’ ä¿®æ”¹ â†’ å¯«å…¥
}
```

### è¦ç¯„ 3ï¼šåˆå§‹åŒ–ç«¯é»å¿…é ˆæ˜ç¢ºæˆæ¬Šï¼ˆä¸”ç¦ç”¨è‡ªå‹•åˆå§‹åŒ–ï¼‰
```typescript
// âœ… æ­£ç¢ºçš„åˆå§‹åŒ–ç«¯é»ï¼ˆæ‰‹å‹•ã€æ˜ç¢ºæˆæ¬Šï¼‰
export async function POST(request: NextRequest) {
  // 1. é©—è­‰ç®¡ç†å“¡
  const password = request.headers.get('x-admin-password');
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
  }
  
  // 2. è®€å–ç¾æœ‰è³‡æ–™
  const existingData = await readProjectData();
  
  // 3. ç¢ºèªç”¨æˆ¶çŸ¥é“å¾Œæœ
  const { confirmOverwrite } = await request.json();
  if (!isEmptyData(existingData) && !confirmOverwrite) {
    return NextResponse.json({
      warning: 'ç¾æœ‰è³‡æ–™å°‡è¢«è¦†è“‹',
      existingProjects: existingData.projects.length,
      requireConfirmation: true
    }, { status: 400 });
  }
  
  // 4. è¨˜éŒ„è©³ç´°æ—¥èªŒ
  console.log('âš ï¸ ç®¡ç†å“¡å¼·åˆ¶åˆå§‹åŒ–:', {
    timestamp: new Date().toISOString(),
    existingProjects: existingData.projects.length,
    willOverwrite: !isEmptyData(existingData)
  });
  
  // 5. åŸ·è¡Œåˆå§‹åŒ–
  await writeProjectData(sampleData, true);
  
  return NextResponse.json({ success: true });
}

// â›” è‡ªå‹•åˆå§‹åŒ–ç«¯é»å·²åœç”¨ï¼š/api/initialize
// åƒ…å›å‚³æç¤ºè¨Šæ¯ï¼Œé¿å…ä»»ä½•è®€å–å¤±æ•—æ™‚èª¤è§¸åˆå§‹åŒ–
```

## ğŸ›¡ï¸ Supabase ç‰¹å®šæ³¨æ„äº‹é …

### æ³¨æ„ 1ï¼šä½¿ç”¨ Service Role Key ç¹é RLS
```typescript
// âš ï¸ Service Role Key æ“æœ‰å®Œå…¨æ¬Šé™ï¼Œåƒ…åœ¨å¾Œç«¯ä½¿ç”¨
import { supabaseAdmin } from '@/lib/supabase';

// âŒ éŒ¯èª¤ï¼šåœ¨å‰ç«¯ä½¿ç”¨ service role key
// é€™æœƒæš´éœ²å®Œå…¨æ¬Šé™çµ¦æ‰€æœ‰ç”¨æˆ¶

// âœ… æ­£ç¢ºï¼šåƒ…åœ¨ API routes ä½¿ç”¨
export async function POST(request: NextRequest) {
  // é©—è­‰ç®¡ç†å“¡æ¬Šé™å¾Œï¼Œæ‰ä½¿ç”¨ supabaseAdmin
  if (!verifyAdmin(request)) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // ç¾åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨ supabaseAdmin
  const { data, error } = await supabaseAdmin
    .from('projects')
    .insert(newProject);
}
```

### æ³¨æ„ 2ï¼šRow Level Security (RLS) æ”¿ç­–
```typescript
// âœ… å‰ç«¯ä½¿ç”¨ supabaseï¼ˆå— RLS é™åˆ¶ï¼‰
import { supabase } from '@/lib/supabase';

// åªèƒ½è®€å–å…¬é–‹è³‡æ–™
const { data } = await supabase
  .from('projects')
  .select('*')
  .eq('hidden', false); // RLS æœƒè‡ªå‹•å¼·åˆ¶æ­¤æ¢ä»¶

// âœ… å¾Œç«¯ä½¿ç”¨ supabaseAdminï¼ˆç¹é RLSï¼‰
const { data } = await supabaseAdmin
  .from('projects')
  .select('*'); // å¯è®€å–æ‰€æœ‰è³‡æ–™ï¼ŒåŒ…æ‹¬ hidden = true
```

### æ³¨æ„ 3ï¼šPostgreSQL äº‹å‹™èˆ‡åŸå­æ€§
```typescript
// âœ… Supabase æ”¯æ´äº‹å‹™ï¼ˆèˆ‡ Blob çš„ä¸»è¦å·®ç•°ï¼‰
// ä½¿ç”¨ rpc åŸ·è¡Œè¤‡é›œäº‹å‹™
const { data, error } = await supabaseAdmin.rpc('batch_update_projects', {
  project_ids: ['id1', 'id2'],
  new_status: 'completed'
});

// âœ… æ‰¹é‡æ“ä½œçš„åŸå­æ€§
const { data, error } = await supabaseAdmin
  .from('projects')
  .insert([project1, project2, project3]); // å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±æ•—

// å¦‚æœéœ€è¦è·¨è¡¨æ“ä½œï¼Œä½¿ç”¨ PostgreSQL äº‹å‹™ï¼š
// BEGIN; ... COMMIT; æˆ– ROLLBACK;
```

### æ³¨æ„ 4ï¼šé€£æ¥æ± èˆ‡è¶…æ™‚
```typescript
// âš ï¸ Serverless ç’°å¢ƒçš„é€£æ¥é™åˆ¶
// Supabase å…è²»ç‰ˆï¼šæœ€å¤š 60 å€‹ä¸¦ç™¼é€£æ¥

// âœ… æ­£ç¢ºï¼šä½¿ç”¨ supabaseAdmin å·²ç¶“æœ‰é€£æ¥æ± ç®¡ç†
// ç„¡éœ€æ‰‹å‹•ç®¡ç†é€£æ¥

// âš ï¸ æŸ¥è©¢è¶…æ™‚è¨­å®š
const { data, error } = await supabaseAdmin
  .from('projects')
  .select('*')
  .abortSignal(AbortSignal.timeout(5000)); // 5 ç§’è¶…æ™‚
```

## ğŸ“‹ ä»£ç¢¼å¯©æŸ¥æª¢æŸ¥æ¸…å–®

åœ¨å¯¦ä½œæˆ–å¯©æŸ¥æ¶‰åŠè³‡æ–™å¯«å…¥çš„ä»£ç¢¼æ™‚ï¼Œå¿…é ˆç¢ºèªï¼š

### å¯«å…¥æ“ä½œæª¢æŸ¥
- [ ] æ˜¯å¦éœ€è¦ç®¡ç†å“¡æˆæ¬Šï¼Ÿå·²å¯¦ä½œé©—è­‰ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨ `forceWrite` åƒæ•¸ï¼Ÿæ˜¯å¦å¿…è¦ï¼Ÿ
- [ ] æ˜¯å¦æœ‰è³‡æ–™å®Œæ•´æ€§é©—è­‰ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç©ºè³‡æ–™ä¿è­·ï¼Ÿ
- [ ] æ˜¯å¦æ›´æ–°äº† `metadata.lastUpdated`ï¼Ÿ
- [ ] æ˜¯å¦è¨˜éŒ„äº†è©³ç´°çš„æ“ä½œæ—¥èªŒï¼Ÿ

### è®€å–æ“ä½œæª¢æŸ¥
- [ ] æ˜¯å¦å€åˆ†äº†ã€Œä¸å­˜åœ¨ã€å’Œã€Œè®€å–å¤±æ•—ã€ï¼Ÿ
- [ ] éŒ¯èª¤è™•ç†æ˜¯å¦æœƒæ„å¤–è§¸ç™¼åˆå§‹åŒ–ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é©ç•¶çš„éŒ¯èª¤æ—¥èªŒï¼Ÿ
- [ ] æ˜¯å¦è€ƒæ…®äº†å†·å•Ÿå‹•æƒ…æ³ï¼Ÿ

### åˆå§‹åŒ–ç«¯é»æª¢æŸ¥
- [ ] æ˜¯å¦æ˜¯ POST è€Œé GETï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ç®¡ç†å“¡å¯†ç¢¼ï¼Ÿ
- [ ] æ˜¯å¦æœƒåœ¨ç”¨æˆ¶ä¸çŸ¥æƒ…æ™‚åŸ·è¡Œï¼Ÿ
- [ ] æ˜¯å¦æœ‰è¦†è“‹ç¾æœ‰è³‡æ–™çš„é¢¨éšªï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç¢ºèªæ©Ÿåˆ¶ï¼Ÿ
- [ ] æ˜¯å¦æœ‰è©³ç´°çš„æ“ä½œæ—¥èªŒï¼Ÿ

### è‡ªå‹•åŒ–é‚è¼¯æª¢æŸ¥
- [ ] æ˜¯å¦åœ¨å•Ÿå‹•æ™‚è‡ªå‹•åŸ·è¡Œï¼Ÿâ†’ å¦‚æœæ˜¯ï¼Œå¿…é ˆé‡æ–°è¨­è¨ˆ
- [ ] æ˜¯å¦åœ¨éŒ¯èª¤è™•ç†ä¸­è§¸ç™¼å¯«å…¥ï¼Ÿâ†’ å¦‚æœæ˜¯ï¼Œå¿…é ˆç§»é™¤
- [ ] æ˜¯å¦å‡è¨­è®€å–å¤±æ•—ç­‰æ–¼ç©ºè³‡æ–™ï¼Ÿâ†’ å¦‚æœæ˜¯ï¼Œå¿…é ˆä¿®æ­£

## ğŸš« çµ•å°ç¦æ­¢çš„æ¨¡å¼

### 1. è‡ªå‹•åˆå§‹åŒ–ç«¯é»
```typescript
// â›” çµ•å°ç¦æ­¢
export async function GET() {
  const data = await readProjectData();
  if (isEmptyData(data)) {
    await writeProjectData(sampleData, true);
  }
  return NextResponse.json(data);
}
```

### 2. éŒ¯èª¤è™•ç†ä¸­çš„éœé»˜å¯«å…¥
```typescript
// â›” çµ•å°ç¦æ­¢
try {
  const data = await readProjectData();
} catch (error) {
  await writeProjectData(defaultData, true); // å±éšªï¼
}
```

### 3. é è¨­å•Ÿç”¨å¼·åˆ¶å¯«å…¥
```typescript
// â›” çµ•å°ç¦æ­¢
async function saveData(data) {
  await writeProjectData(data, true); // forceWrite æ‡‰è©²æ˜¯ä¾‹å¤–ï¼Œä¸æ˜¯å¸¸æ…‹
}
```

### 4. ç„¡é©—è­‰çš„å¯«å…¥ç«¯é»
```typescript
// â›” çµ•å°ç¦æ­¢
export async function POST(request: NextRequest) {
  const data = await request.json();
  await writeProjectData(data); // æ²’æœ‰é©—è­‰ï¼
}
```

### 5. åœ¨ middleware æˆ–å…¨åŸŸæª”æ¡ˆä¸­å¯«å…¥
```typescript
// â›” çµ•å°ç¦æ­¢
// middleware.ts æˆ– layout.tsx ä¸­
const data = await readProjectData();
if (!data) {
  await writeProjectData(defaultData); // å¤ªæ—©ã€å¤ªè‡ªå‹•åŒ–
}
```

## âœ… æ¨è–¦çš„å®‰å…¨æ¨¡å¼

### æ¨¡å¼ 1ï¼šè®€å–-ä¿®æ”¹-å¯«å…¥æ¨¡å¼
```typescript
export async function POST(request: NextRequest) {
  // 1. é©—è­‰
  const password = request.headers.get('x-admin-password');
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
  }

  // 2. è®€å–
  const data = await readProjectData();
  
  // 3. ä¿®æ”¹
  const updates = await request.json();
  const updatedData = {
    ...data,
    projects: [...data.projects, newProject],
    metadata: {
      ...data.metadata,
      lastUpdated: Date.now(),
      totalProjects: data.projects.length + 1
    }
  };
  
  // 4. é©—è­‰
  const { isValid, errors } = validateDataIntegrity(updatedData);
  if (!isValid) {
    return NextResponse.json({ error: errors }, { status: 400 });
  }
  
  // 5. å¯«å…¥ï¼ˆä¸ä½¿ç”¨ forceWriteï¼‰
  await writeProjectData(updatedData);
  
  return NextResponse.json({ success: true });
}
```

### æ¨¡å¼ 2ï¼šé˜²ç¦¦æ€§è®€å–
```typescript
async function safeReadProjectData(): Promise<ProjectData> {
  try {
    // ç¢ºèªæª”æ¡ˆå­˜åœ¨
    const { blobs } = await list();
    const dataBlob = blobs.find(blob => blob.pathname === BLOB_FILENAME);
    
    if (!dataBlob) {
      console.log('ğŸ“„ æª”æ¡ˆä¸å­˜åœ¨ï¼Œé€™æ˜¯æ­£å¸¸çš„é¦–æ¬¡éƒ¨ç½²æƒ…æ³');
      return defaultProjectData;
    }

    // è®€å–å…§å®¹
    const response = await fetch(dataBlob.url);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    
    // é©—è­‰è³‡æ–™
    if (!validateProjectData(data)) {
      throw new Error('è³‡æ–™æ ¼å¼é©—è­‰å¤±æ•—');
    }

    return data;
    
  } catch (error) {
    console.error('ğŸ’¥ è®€å–å¤±æ•—:', error);
    // ä¸è¿”å›é è¨­å€¼ï¼Œæ‹‹å‡ºéŒ¯èª¤è®“èª¿ç”¨è€…è™•ç†
    throw new Error(`ç„¡æ³•è®€å–å°ˆæ¡ˆè³‡æ–™: ${error.message}`);
  }
}
```

### æ¨¡å¼ 3ï¼šå‚™ä»½å‰å¯«å…¥
```typescript
async function safeWriteProjectData(data: ProjectData) {
  // è®€å–ç¾æœ‰è³‡æ–™ä½œç‚ºå‚™ä»½åƒè€ƒ
  let existingData: ProjectData | null = null;
  try {
    existingData = await readProjectData();
  } catch (error) {
    console.warn('ç„¡æ³•è®€å–ç¾æœ‰è³‡æ–™é€²è¡Œå‚™ä»½');
  }

  // å¦‚æœæœ‰ç¾æœ‰è³‡æ–™ï¼Œè¨˜éŒ„åœ¨å…ƒè³‡æ–™ä¸­
  if (existingData && !isEmptyData(existingData)) {
    data.metadata.previousBackup = {
      timestamp: existingData.metadata.lastUpdated,
      projectCount: existingData.projects.length
    };
  }

  // å¯«å…¥
  await writeProjectData(data);
}
```

## ğŸ“ å¯¦ä½œæ–°åŠŸèƒ½æ™‚çš„å®‰å…¨æµç¨‹

ç•¶éœ€è¦å¯¦ä½œæ¶‰åŠè³‡æ–™å¯«å…¥çš„æ–°åŠŸèƒ½æ™‚ï¼Œéµå¾ªä»¥ä¸‹æµç¨‹ï¼š

1. **è¨­è¨ˆéšæ®µ**
   - [ ] æ˜¯å¦çœŸçš„éœ€è¦å¯«å…¥è³‡æ–™ï¼Ÿ
   - [ ] èƒ½å¦ç”¨ç´”è®€å–å¯¦ç¾ï¼Ÿ
   - [ ] å¯«å…¥çš„è§¸ç™¼æ¢ä»¶æ˜¯ä»€éº¼ï¼Ÿ

2. **å¯¦ä½œéšæ®µ**
   - [ ] å¯¦ä½œç®¡ç†å“¡é©—è­‰
   - [ ] å¯¦ä½œè³‡æ–™é©—è­‰
   - [ ] å¯¦ä½œéŒ¯èª¤è™•ç†ï¼ˆä¸éœé»˜å¤±æ•—ï¼‰
   - [ ] æ·»åŠ è©³ç´°æ—¥èªŒ

3. **æ¸¬è©¦éšæ®µ**
   - [ ] æ¸¬è©¦æ­£å¸¸å¯«å…¥æµç¨‹
   - [ ] æ¸¬è©¦é©—è­‰å¤±æ•—æƒ…æ³
   - [ ] æ¸¬è©¦æœªæˆæ¬Šè¨ªå•
   - [ ] æ¸¬è©¦éŒ¯èª¤æ¢å¾©
   - [ ] æ¸¬è©¦å†·å•Ÿå‹•æƒ…æ³

4. **éƒ¨ç½²éšæ®µ**
   - [ ] ç¢ºèªç¾æœ‰è³‡æ–™å·²å‚™ä»½
   - [ ] éƒ¨ç½²å¾Œç«‹å³æ¸¬è©¦è®€å–
   - [ ] ç›£æ§éŒ¯èª¤æ—¥èªŒ
   - [ ] æº–å‚™å›æ»¾è¨ˆç•«

## ğŸ†˜ ç·Šæ€¥æƒ…æ³è™•ç†

å¦‚æœç™¼ç¾è³‡æ–™è¢«æ„å¤–è¦†å¯«æˆ–åˆªé™¤ï¼š

1. **ç«‹å³åœæ­¢**ï¼šåœæ­¢æ‰€æœ‰è‡ªå‹•åŒ–éƒ¨ç½²
2. **æª¢æŸ¥å‚™ä»½**ï¼š
   - Supabase è‡ªå‹•å‚™ä»½ï¼ˆPoint-in-Time Recoveryï¼‰
   - æœ¬åœ°å‚™ä»½æª”æ¡ˆ
   - Git æ­·å²è¨˜éŒ„
3. **ä½¿ç”¨é‚„åŸåŠŸèƒ½**ï¼š
   - Supabase æ§åˆ¶å°çš„ Point-in-Time Recovery
   - æˆ–é€éç®¡ç†å¾Œå°çš„åŒ¯å…¥åŠŸèƒ½é‚„åŸ
4. **åˆ†æåŸå› **ï¼šæª¢æŸ¥ Supabase æ—¥èªŒå’Œæ‡‰ç”¨æ—¥èªŒæ‰¾å‡ºè§¸ç™¼åŸå› 
5. **ä¿®å¾©ä»£ç¢¼**ï¼šæ ¹æ“šæœ¬è¦å‰‡ä¿®æ­£å•é¡Œ
6. **åŠ å¼·é˜²è­·**ï¼š
   - æª¢æŸ¥ RLS æ”¿ç­–æ˜¯å¦æ­£ç¢º
   - ç¢ºèª constraints æ˜¯å¦è¶³å¤ 
   - æ·»åŠ æ›´å¤šè³‡æ–™åº«å±¤ç´šçš„ä¿è­·

## ğŸ¯ ç¸½çµï¼šé»ƒé‡‘æ³•å‰‡ï¼ˆSupabase ç‰ˆï¼‰

1. **æ°¸ä¸ä¿¡ä»»è‡ªå‹•åŒ–**ï¼šä»»ä½•è‡ªå‹•åŸ·è¡Œçš„å¯«å…¥é‚è¼¯éƒ½æ˜¯é¢¨éšª
2. **è®€å–å¤±æ•—æ‹‹éŒ¯èª¤**ï¼šæ˜ç¢ºè™•ç† `error`ï¼Œä¸è¦éœé»˜è¿”å›ç©ºè³‡æ–™
3. **åˆ©ç”¨è³‡æ–™åº«ä¿è­·**ï¼šä½¿ç”¨ PostgreSQL constraintsã€RLSã€äº‹å‹™
4. **Service Role éœ€æˆæ¬Š**ï¼š`supabaseAdmin` åƒ…åœ¨é©—è­‰å¾Œä½¿ç”¨
5. **è©³ç´°æ—¥èªŒè¨˜éŒ„**ï¼šè¨˜éŒ„æ‰€æœ‰è³‡æ–™åº«æ“ä½œå’ŒéŒ¯èª¤
6. **å€åˆ†æƒ…æ³è™•ç†**ï¼š`error` â‰  `data === null` â‰  `data.length === 0`
7. **å–„ç”¨ PostgreSQL éŒ¯èª¤ç¢¼**ï¼šæ ¹æ“šéŒ¯èª¤ç¢¼æä¾›ç²¾ç¢ºçš„éŒ¯èª¤è¨Šæ¯

### Supabase ç‰¹æœ‰å„ªå‹¢

âœ… **PostgreSQL æä¾›çš„ä¿è­·**ï¼š
- Constraints è‡ªå‹•é©—è­‰è³‡æ–™å®Œæ•´æ€§
- RLS è‡ªå‹•æ§åˆ¶å­˜å–æ¬Šé™
- Triggers å¯å¯¦ç¾è‡ªå‹•å¯©è¨ˆ
- äº‹å‹™ä¿è­‰åŸå­æ€§

âœ… **ä¸å†éœ€è¦æ‰‹å‹•å¯¦ä½œ**ï¼š
- âŒ `forceWrite` åƒæ•¸ï¼ˆRLS å–ä»£ï¼‰
- âŒ `safetyCheck` æ¨™è¨˜ï¼ˆTimestamps è‡ªå‹•ç®¡ç†ï¼‰
- âŒ ç©ºè³‡æ–™ä¿è­·ï¼ˆConstraints è™•ç†ï¼‰
- âŒ æ‰‹å‹•å‚™ä»½æ¨™è¨˜ï¼ˆPoint-in-Time Recoveryï¼‰

---

> ğŸ’¡ **è¨˜ä½**ï¼šSupabase PostgreSQL æä¾›ä¼æ¥­ç´šè³‡æ–™ä¿è­·ã€‚
> å–„ç”¨è³‡æ–™åº«å±¤ç´šçš„å®‰å…¨æ©Ÿåˆ¶ï¼Œè€Œéåœ¨æ‡‰ç”¨å±¤é‡è¤‡å¯¦ä½œã€‚
> RLS + Constraints + äº‹å‹™ = å¼·å¤§çš„è³‡æ–™å®‰å…¨ä¿éšœã€‚
