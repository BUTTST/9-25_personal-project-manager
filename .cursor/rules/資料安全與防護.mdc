---
globs: app/lib/**/*.ts,app/api/**/*.ts
---

# 資料安全與防護

## Supabase 安全機制

### Row Level Security (RLS)

Supabase 使用 RLS 保護資料：
- 公開查詢：使用 `supabase` 客戶端（受 RLS 限制）
- 管理員操作：使用 `supabaseAdmin` 客戶端（繞過 RLS）

### 客戶端選擇

根據 [app/lib/supabase.ts](mdc:app/lib/supabase.ts)：

```typescript
// 公開操作（受 RLS 限制）
import { supabase } from '@/lib/supabase';
const { data } = await supabase.from('projects').select('*');

// 管理員操作（繞過 RLS）
import { supabaseAdmin } from '@/lib/supabase';
if (!supabaseAdmin) {
  return NextResponse.json({ error: 'Admin client not available' }, { status: 500 });
}
const { data } = await supabaseAdmin.from('projects').insert(...);
```

## 資料驗證

### 輸入驗證

所有 API 端點應驗證輸入：

```typescript
const formData: ProjectFormData = await request.json();

// 驗證必要欄位
if (!formData.dateAndFileName || !formData.description) {
  return NextResponse.json(
    { error: '專案名稱和說明為必填欄位' },
    { status: 400 }
  );
}

// 清理輸入
const cleanedData = {
  dateAndFileName: formData.dateAndFileName.trim(),
  description: formData.description.trim(),
};
```

### 型別驗證

使用 TypeScript 型別和輔助函式：

```typescript
import { 
  ensureProjectVisibility, 
  normalizeProjectStatus 
} from '@/types';

const visibility = ensureProjectVisibility(formData.visibility);
const status = normalizeProjectStatus(formData.status, formData.category);
```

## 檔案上傳安全

根據 [app/lib/storage.ts](mdc:app/lib/storage.ts)：

### 檔名處理

1. **ASCII 轉換**：移除中文字符，確保 Supabase Storage 相容性
2. **Hash 識別**：生成檔名 hash，避免重複上傳
3. **衝突處理**：自動添加序號處理檔名衝突

```typescript
// 清理檔名
let safeFilename = filename
  .replace(/[\u4e00-\u9fa5]/g, '') // 移除中文
  .replace(/[^a-zA-Z0-9._()-]/g, '-') // 非法字符替換
  .replace(/^-+|-+$/g, '') // 移除首尾連字號
  .replace(/-{2,}/g, '-'); // 合併多個連字號
```

### 重複檢查

上傳前檢查：
1. 原始檔名 hash 是否已存在
2. 清理後檔名是否衝突

## 資料完整性

### 交易處理

重要操作應確保資料一致性：

```typescript
// 1. 上傳檔案到 Storage
const { data, error } = await supabaseAdmin.storage
  .from(BUCKET_NAME)
  .upload(filename, file);

if (error) {
  return { success: false, error: error.message };
}

// 2. 同步寫入資料庫
const { error: dbError } = await supabaseAdmin
  .from('image_metadata')
  .insert({ stored_filename: filename, ... });

if (dbError) {
  // 可選：刪除已上傳的檔案以保持一致性
  console.error('資料庫寫入失敗:', dbError);
}
```

### 引用追蹤

圖片重命名時自動更新專案引用：

```typescript
import { updateImageReferences } from '@/lib/storage';

// 重命名後更新引用
await updateImageReferences(oldFilename, newFilename, projectIds);
```

## 錯誤處理

### 安全錯誤訊息

不洩露敏感資訊：

```typescript
try {
  // 操作
} catch (error) {
  console.error('Internal error:', error); // 記錄完整錯誤
  return NextResponse.json(
    { error: '操作失敗' }, // 使用者友善訊息
    { status: 500 }
  );
}
```

### 詳細錯誤（僅開發環境）

```typescript
return NextResponse.json(
  { 
    error: '操作失敗',
    ...(process.env.NODE_ENV === 'development' && { 
      details: error.message 
    })
  },
  { status: 500 }
);
```

## 環境變數保護

### 伺服器端變數

絕不在客戶端暴露：
- `ADMIN_PASSWORD`
- `SUPABASE_SERVICE_ROLE_KEY`

### 客戶端變數

使用 `NEXT_PUBLIC_` 前綴：
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

## 資料備份

### 自動備份

重要操作前可考慮備份：
```typescript
// 備份邏輯（如需要）
const backup = await createBackup();
```

### 版本控制

使用 Git 追蹤配置檔案和腳本，不追蹤敏感資料。

## 最佳實踐

1. **最小權限原則**：公開查詢使用 RLS，管理員操作使用 Admin Client
2. **輸入驗證**：所有輸入都應驗證和清理
3. **錯誤處理**：不洩露敏感資訊
4. **資料一致性**：重要操作確保原子性
5. **環境變數**：敏感資訊僅在伺服器端使用
