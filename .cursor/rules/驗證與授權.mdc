---
globs: app/api/**/*.ts,app/lib/auth.ts,app/components/auth/**/*.tsx
---

# 驗證與授權指南

## 認證機制

### 密碼驗證

管理員使用簡單密碼驗證系統：
- 環境變數：`ADMIN_PASSWORD`
- API 端點：`POST /api/auth/login`
- 驗證標頭：`x-admin-password`

### 工作階段管理

使用 [app/lib/auth.ts](mdc:app/lib/auth.ts) 管理本地工作階段：

```typescript
import { 
  createAdminSession, 
  getCurrentSession, 
  clearSession,
  isAdmin 
} from '@/lib/auth';

// 建立工作階段
const session = createAdminSession();

// 檢查是否為管理員
if (isAdmin()) {
  // 管理員操作
}

// 清除工作階段
clearSession();
```

### 工作階段特性

- **持續時間**：24 小時
- **儲存位置**：`localStorage`（`admin_session`）
- **過期檢查**：自動檢查並清除過期工作階段

## 密碼記憶功能

```typescript
import { 
  rememberPassword, 
  getRememberedPassword, 
  clearRememberedPassword 
} from '@/lib/auth';

// 記憶密碼
rememberPassword(password);

// 獲取記憶的密碼
const password = getRememberedPassword();

// 清除記憶的密碼
clearRememberedPassword();
```

## API 路由認證

### 讀取操作（GET）

預設為公開，無需認證：
```typescript
export async function GET(request: NextRequest) {
  // 公開查詢
  const { data } = await supabase.from('projects').select('*');
}
```

管理員模式（可選）：
```typescript
const isAdmin = searchParams.get('admin') === 'true';
const password = request.headers.get('x-admin-password');

if (isAdmin) {
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: '未授權訪問' }, { status: 401 });
  }
  // 管理員查詢（包含隱藏專案）
}
```

### 寫入操作（POST/PATCH/DELETE）

必須驗證管理員權限：
```typescript
export async function POST(request: NextRequest) {
  const password = request.headers.get('x-admin-password');
  
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: '未授權訪問' }, { status: 401 });
  }
  
  // 管理員操作
}
```

## 前端認證

### AuthProvider

使用 `AuthProvider` 元件管理全域認證狀態：

```typescript
import { AuthProvider } from '@/components/auth/AuthProvider';

<AuthProvider>
  {children}
</AuthProvider>
```

### 使用認證狀態

```typescript
import { useAuth } from '@/components/auth/AuthProvider';

const { isAdmin, isAuthenticated } = useAuth();
```

### 登入流程

1. 使用者輸入密碼
2. 呼叫 `POST /api/auth/login`
3. 成功後建立本地工作階段
4. 可選：記憶密碼到 `localStorage`

## 權限控制

### 元件層級

```typescript
{isAdmin && <AdminControls />}
{isAuthenticated && <ProtectedContent />}
```

### API 層級

所有寫入操作必須檢查：
```typescript
if (!isAdmin()) {
  return NextResponse.json({ error: '未授權' }, { status: 403 });
}
```

## 安全最佳實踐

1. **環境變數保護**：`ADMIN_PASSWORD` 僅在伺服器端使用
2. **HTTPS 強制**：生產環境使用 HTTPS
3. **工作階段過期**：24 小時自動過期
4. **密碼記憶可選**：使用者可選擇是否記憶
5. **錯誤訊息**：不洩露敏感資訊

## 環境變數

必需：
- `ADMIN_PASSWORD` - 管理員密碼（伺服器端）

可選：
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase Anon Key
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase Service Role Key

## 錯誤處理

認證失敗回應：
```typescript
return NextResponse.json(
  { error: '未授權訪問' },
  { status: 401 }
);
```

禁止訪問回應：
```typescript
return NextResponse.json(
  { error: '權限不足' },
  { status: 403 }
);
```
