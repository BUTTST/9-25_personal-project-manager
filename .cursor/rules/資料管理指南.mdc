---
globs: app/lib/**/*.ts,app/api/**/*.ts
---

# 資料管理指南

## Supabase 架構

### 資料庫表結構

#### `projects` 表

專案主要資料：
- `id` (string) - 唯一識別碼
- `date_and_file_name` (string) - 專案名稱
- `description` (text) - 專案說明
- `category` (string) - 專案類別
- `status` (string) - 專案狀態
- `visibility` (jsonb) - 可見性設定
- `image_previews` (jsonb) - 圖片預覽陣列
- `custom_info_sections` (jsonb) - 自訂資訊區塊
- `featured` (boolean) - 是否精選
- `hidden` (boolean) - 是否隱藏
- `sort_order` (integer) - 排序順序
- `created_at` (timestamp) - 建立時間
- `updated_at` (timestamp) - 更新時間

#### `settings` 表

應用設定（JSONB）：
- `key` (string) - 設定鍵
- `value` (jsonb) - 設定值
- `updated_at` (timestamp) - 更新時間

常用鍵：
- `app_settings` - 應用設定
- `ui_display` - UI 顯示設定

#### `image_metadata` 表

圖片元數據：
- `stored_filename` (string) - 存儲檔名（ASCII）
- `original_filename` (string) - 原始檔名（中文）
- `file_size` (integer) - 檔案大小
- `content_type` (string) - MIME 類型
- `file_hash` (string) - 檔名 hash
- `created_at` (timestamp) - 建立時間
- `updated_at` (timestamp) - 更新時間

### Storage Bucket

- **名稱**：`project-images`
- **公開讀取**：是
- **檔案命名**：ASCII 格式，包含 hash 識別

## 資料操作模式

### 查詢專案

```typescript
import { supabase, supabaseAdmin } from '@/lib/supabase';

// 公開查詢（受 RLS 限制）
const { data: projects } = await supabase
  .from('projects')
  .select('*')
  .eq('hidden', false)
  .order('sort_order', { ascending: true });

// 管理員查詢（所有專案）
const { data: allProjects } = await supabaseAdmin
  .from('projects')
  .select('*')
  .order('sort_order', { ascending: true });
```

### 新增專案

```typescript
// 轉換格式：camelCase → snake_case
const dbData = {
  id: generateId(),
  date_and_file_name: formData.dateAndFileName,
  description: formData.description,
  category: formData.category,
  status: formData.status,
  visibility: formData.visibility,
  image_previews: formData.imagePreviews,
  sort_order: nextSortOrder,
};

const { data, error } = await supabaseAdmin
  .from('projects')
  .insert(dbData)
  .select()
  .single();
```

### 更新專案

```typescript
const { data, error } = await supabaseAdmin
  .from('projects')
  .update({
    date_and_file_name: updatedData.dateAndFileName,
    updated_at: new Date().toISOString(),
  })
  .eq('id', projectId)
  .select()
  .single();
```

### 刪除專案

```typescript
const { error } = await supabaseAdmin
  .from('projects')
  .delete()
  .eq('id', projectId);
```

## 圖片管理

### 上傳圖片

使用 [app/lib/storage.ts](mdc:app/lib/storage.ts)：

```typescript
import { uploadImage } from '@/lib/storage';

const result = await uploadImage(file, filename);
if (result.success) {
  // 使用 result.url
}
```

### 列出圖片

```typescript
import { listImages } from '@/lib/storage';

const { files } = await listImages();
// files 包含 originalFilename（中文檔名）
```

### 刪除圖片

```typescript
import { deleteImage } from '@/lib/storage';

const result = await deleteImage(filename);
```

### 檢查引用

```typescript
import { checkImageReferences } from '@/lib/storage';

const { references } = await checkImageReferences(filename);
// references 包含使用該圖片的專案列表
```

## 設定管理

### 讀取設定

```typescript
const { data: settingsData } = await supabaseAdmin
  .from('settings')
  .select('*');

const appSettings = settingsData?.find(s => s.key === 'app_settings')?.value;
const uiDisplay = settingsData?.find(s => s.key === 'ui_display')?.value;
```

### 更新設定

```typescript
await supabaseAdmin
  .from('settings')
  .upsert({
    key: 'ui_display',
    value: uiDisplaySettings,
    updated_at: new Date().toISOString(),
  });
```

## 資料格式轉換

### 專案資料轉換

API 回應時轉換為 camelCase：

```typescript
const formattedProject = {
  id: dbProject.id,
  dateAndFileName: dbProject.date_and_file_name,
  imagePreviews: dbProject.image_previews,
  createdAt: new Date(dbProject.created_at).getTime(),
  updatedAt: new Date(dbProject.updated_at).getTime(),
};
```

### 時間戳轉換

- 資料庫：ISO 字串（`created_at`）
- API 回應：Unix 時間戳（`createdAt`）

## 排序管理

### 獲取最大排序值

```typescript
const { data: existingProjects } = await supabaseAdmin
  .from('projects')
  .select('sort_order')
  .order('sort_order', { ascending: false })
  .limit(1);

const nextSortOrder = existingProjects?.[0]?.sort_order + 1 || 0;
```

### 重新排序

```typescript
// 批量更新排序
for (const [index, projectId] of orderedIds.entries()) {
  await supabaseAdmin
    .from('projects')
    .update({ sort_order: index })
    .eq('id', projectId);
}
```

## 錯誤處理

### Supabase 錯誤

```typescript
const { data, error } = await supabaseAdmin.from('projects').select('*');

if (error) {
  console.error('Database error:', error);
  return NextResponse.json(
    { error: '無法載入專案', details: error.message },
    { status: 500 }
  );
}
```

### 空值處理

```typescript
const projects = data || [];
const github = dbProject.github || '';
const imagePreviews = dbProject.image_previews || [];
```

## 最佳實踐

1. **使用型別**：使用 TypeScript 型別確保資料結構正確
2. **轉換函式**：使用輔助函式處理格式轉換
3. **錯誤處理**：所有資料庫操作都應處理錯誤
4. **空值處理**：使用 `||` 提供預設值
5. **時間戳**：統一使用 Unix 時間戳或 ISO 字串
