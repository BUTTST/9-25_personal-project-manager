---
globs: "app/lib/**/*.ts,app/api/**/*.ts"
---
# è³‡æ–™ç®¡ç†æŒ‡å—

> ğŸ“… æ›´æ–°æ—¥æœŸï¼š2025-10-28  
> ğŸ”„ ç‰ˆæœ¬ï¼šv2.0ï¼ˆSupabase ç‰ˆæœ¬ï¼‰

## ğŸ—„ï¸ å„²å­˜æ¶æ§‹

### è³‡æ–™åº«

æ‰€æœ‰æŒä¹…æ€§è³‡æ–™éƒ½å„²å­˜åœ¨ **Supabase PostgreSQL** è³‡æ–™åº«ä¸­ï¼š

```yaml
è³‡æ–™è¡¨:
  - projects: å°ˆæ¡ˆè³‡æ–™ï¼ˆ22å€‹æ¬„ä½ï¼‰
  - passwords: å¯†ç¢¼è³‡æ–™ï¼ˆ6å€‹æ¬„ä½ï¼‰
  - settings: æ‡‰ç”¨è¨­å®šï¼ˆkey-valueï¼‰

Storage:
  - screenshots bucket: åœ–ç‰‡å„²å­˜
```

### é…ç½®æª”æ¡ˆ

- **Supabase Client**ï¼š[app/lib/supabase.ts](mdc:app/lib/supabase.ts)
- **Storage æ“ä½œ**ï¼š[app/lib/storage.ts](mdc:app/lib/storage.ts)

---

## ğŸ“Š è³‡æ–™çµæ§‹

### Projects è¡¨

```typescript
interface Project {
  id: string;                          // ä¸»éµï¼ˆtextï¼‰
  date_and_file_name: string;          // å°ˆæ¡ˆåç¨±
  description: string;                 // èªªæ˜
  category: string;                    // é¡åˆ¥
  status: string;                      // ç‹€æ…‹
  github?: string;                     // GitHub é€£çµ
  vercel?: string;                     // Vercel é€£çµ
  deployment?: string;                 // éƒ¨ç½²ç¶²å€
  path?: string;                       // æœ¬åœ°è·¯å¾‘
  status_note?: string;                // ç‹€æ…‹è¨»è§£
  public_note?: string;                // å…¬é–‹è¨»è§£
  developer_note?: string;             // é–‹ç™¼è€…è¨»è§£
  visibility: Record<string, boolean>; // å¯è¦‹æ€§è¨­å®šï¼ˆJSONBï¼‰
  image_previews: Array<{              // åœ–ç‰‡é è¦½ï¼ˆJSONBï¼‰
    id: string;
    title: string;
    src: string;
  }>;
  image_preview_mode: string;          // åœ–ç‰‡é¡¯ç¤ºæ¨¡å¼
  custom_info_sections: Array<any>;    // è‡ªè¨‚è³‡è¨Šï¼ˆJSONBï¼‰
  document_meta?: Record<string, any>; // æ–‡ä»¶å…ƒè³‡æ–™ï¼ˆJSONBï¼‰
  featured: boolean;                   // æ˜¯å¦ç²¾é¸
  hidden: boolean;                     // æ˜¯å¦éš±è—
  sort_order: number;                  // æ’åºé †åº
  created_at: string;                  // å»ºç«‹æ™‚é–“ï¼ˆtimestamptzï¼‰
  updated_at: string;                  // æ›´æ–°æ™‚é–“ï¼ˆtimestamptzï¼‰
}
```

### Passwords è¡¨

```typescript
interface Password {
  id: string;
  platform: string;
  account: string;
  password: string;
  created_at: string;
  updated_at: string;
}
```

### Settings è¡¨

```typescript
interface Settings {
  key: string;                    // ä¸»éµ
  value: Record<string, any>;     // JSONB å€¼
  updated_at: string;
}

// é è¨­ keys:
// - 'app_settings': æ‡‰ç”¨é…ç½®
// - 'ui_display': UI é¡¯ç¤ºè¨­å®š
```

---

## ğŸ”§ è³‡æ–™æ“ä½œ

### è®€å–è³‡æ–™

#### å‰ç«¯ï¼ˆå…¬é–‹è³‡æ–™ï¼‰

```typescript
import { supabase } from '@/app/lib/supabase';

// æŸ¥è©¢å…¬é–‹å°ˆæ¡ˆ
const { data, error } = await supabase
  .from('projects')
  .select('*')
  .eq('hidden', false)
  .order('sort_order');
```

#### å¾Œç«¯ï¼ˆç®¡ç†å“¡ï¼‰

```typescript
import { supabaseAdmin } from '@/app/lib/supabase';

// æŸ¥è©¢æ‰€æœ‰å°ˆæ¡ˆï¼ˆç¹é RLSï¼‰
const { data, error } = await supabaseAdmin
  .from('projects')
  .select('*')
  .order('sort_order');
```

### å¯«å…¥è³‡æ–™

**âš ï¸ é‡è¦**ï¼šæ‰€æœ‰å¯«å…¥æ“ä½œå¿…é ˆï¼š
1. é©—è­‰ç®¡ç†å“¡æ¬Šé™
2. ä½¿ç”¨ `supabaseAdmin`
3. è™•ç†æ¬„ä½åç¨±è½‰æ›ï¼ˆcamelCase â†” snake_caseï¼‰

```typescript
// API Route ä¸­
const password = request.headers.get('x-admin-password');
if (!password || password !== process.env.ADMIN_PASSWORD) {
  return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
}

// æ’å…¥è³‡æ–™
const { data, error } = await supabaseAdmin
  .from('projects')
  .insert({
    date_and_file_name: formData.dateAndFileName,
    description: formData.description,
    // ... å…¶ä»–æ¬„ä½
  })
  .select()
  .single();
```

### æ›´æ–°è³‡æ–™

```typescript
// æ›´æ–°å–®ä¸€å°ˆæ¡ˆ
const { data, error } = await supabaseAdmin
  .from('projects')
  .update({
    description: newDescription,
    updated_at: new Date().toISOString(), // è‡ªå‹•è§¸ç™¼å™¨æœƒè™•ç†
  })
  .eq('id', projectId)
  .select()
  .single();
```

### åˆªé™¤è³‡æ–™

```typescript
// åˆªé™¤å°ˆæ¡ˆ
const { error } = await supabaseAdmin
  .from('projects')
  .delete()
  .eq('id', projectId);
```

---

## ğŸ”„ æ¬„ä½åç¨±è½‰æ›

### è³‡æ–™åº« â†” å‰ç«¯è½‰æ›è¦å‰‡

```typescript
// è³‡æ–™åº«ä½¿ç”¨ snake_case
// å‰ç«¯ä½¿ç”¨ camelCase

// DB â†’ Frontend
const formatProject = (dbRow: any) => ({
  id: dbRow.id,
  dateAndFileName: dbRow.date_and_file_name,
  statusNote: dbRow.status_note,
  publicNote: dbRow.public_note,
  developerNote: dbRow.developer_note,
  imagePreviews: dbRow.image_previews,
  imagePreviewMode: dbRow.image_preview_mode,
  customInfoSections: dbRow.custom_info_sections,
  documentMeta: dbRow.document_meta,
  sortOrder: dbRow.sort_order,
  createdAt: new Date(dbRow.created_at).getTime(),
  updatedAt: new Date(dbRow.updated_at).getTime(),
  // ... å…¶ä»–æ¬„ä½
});

// Frontend â†’ DB
const toDbFormat = (project: any) => ({
  id: project.id,
  date_and_file_name: project.dateAndFileName,
  status_note: project.statusNote || null,
  public_note: project.publicNote || null,
  developer_note: project.developerNote || null,
  image_previews: project.imagePreviews || [],
  image_preview_mode: project.imagePreviewMode || 'grid',
  custom_info_sections: project.customInfoSections || [],
  document_meta: project.documentMeta || null,
  sort_order: project.sortOrder || 0,
  // ... å…¶ä»–æ¬„ä½
});
```

---

## ğŸ–¼ï¸ åœ–ç‰‡ç®¡ç†

### ä¸Šå‚³åœ–ç‰‡

```typescript
import { uploadImage } from '@/app/lib/storage';

// ä¸Šå‚³å–®ä¸€åœ–ç‰‡
const result = await uploadImage(file, customFilename);

if (result.success) {
  console.log('åœ–ç‰‡ URL:', result.url);
  // URL æ ¼å¼: https://[project-id].supabase.co/storage/v1/object/public/screenshots/filename.png
}
```

### åˆ—å‡ºåœ–ç‰‡

```typescript
import { listImages } from '@/app/lib/storage';

const result = await listImages();

if (result.success) {
  result.files.forEach(file => {
    console.log(file.name, file.url, file.size);
  });
}
```

### é‡å‘½ååœ–ç‰‡

```typescript
import { renameImage, updateImageReferences } from '@/app/lib/storage';

// 1. é‡å‘½å Storage ä¸­çš„æª”æ¡ˆ
const result = await renameImage('old.png', 'new.png');

// 2. æ›´æ–°å°ˆæ¡ˆå¼•ç”¨
if (result.success) {
  await updateImageReferences('old.png', 'new.png', affectedProjectIds);
}
```

### åˆªé™¤åœ–ç‰‡

```typescript
import { deleteImage, checkImageReferences } from '@/app/lib/storage';

// 1. æª¢æŸ¥å¼•ç”¨
const refResult = await checkImageReferences('image.png');

if (refResult.references && refResult.references.length > 0) {
  console.warn('åœ–ç‰‡è¢«ä½¿ç”¨ä¸­:', refResult.references);
}

// 2. åˆªé™¤
const result = await deleteImage('image.png');
```

---

## ğŸ”’ Row Level Security (RLS)

### Projects è¡¨

```sql
-- å…¬é–‹è®€å–ï¼ˆè¨ªå®¢ï¼‰
-- æ¢ä»¶ï¼šæœªéš±è— ä¸” description å¯è¦‹
SELECT * FROM projects 
WHERE NOT hidden 
  AND (visibility->>'description')::boolean = true;

-- ç®¡ç†å“¡æ“ä½œï¼ˆé€é service_role keyï¼‰
-- å®Œå…¨å­˜å–ï¼Œç¹é RLS
```

### Passwords è¡¨

```sql
-- å®Œå…¨ç¦æ­¢å‰ç«¯è¨ªå•
-- åƒ…å¾Œç«¯ API å¯æ“ä½œï¼ˆä½¿ç”¨ service_role keyï¼‰
```

### Settings è¡¨

```sql
-- å…¬é–‹è®€å–ï¼šå…è¨±
-- å…¬é–‹å¯«å…¥ï¼šç¦æ­¢
-- ç®¡ç†å“¡å¯«å…¥ï¼šå…è¨±ï¼ˆé€é service_role keyï¼‰
```

---

## ğŸ” å¸¸ç”¨æŸ¥è©¢æ¨¡å¼

### ç¯©é¸æŸ¥è©¢

```typescript
// æŒ‰é¡åˆ¥ç¯©é¸
const { data } = await supabase
  .from('projects')
  .select('*')
  .eq('category', 'important')
  .order('sort_order');

// æŒ‰ç‹€æ…‹ç¯©é¸
const { data } = await supabase
  .from('projects')
  .select('*')
  .eq('status', 'in-progress')
  .order('created_at', { ascending: false });

// è¤‡åˆæ¢ä»¶
const { data } = await supabase
  .from('projects')
  .select('*')
  .eq('category', 'important')
  .eq('hidden', false)
  .order('sort_order');
```

### JSONB æŸ¥è©¢

```typescript
// æŸ¥è©¢ visibility ä¸­çš„ç‰¹å®šå€¼
const { data } = await supabase
  .from('projects')
  .select('*')
  .eq('visibility->description', true);

// æŸ¥è©¢åŒ…å«ç‰¹å®šåœ–ç‰‡çš„å°ˆæ¡ˆ
const { data } = await supabase
  .from('projects')
  .select('*')
  .contains('image_previews', [{ src: '/å‰ç«¯æˆªåœ–/example.png' }]);
```

### å…¨æ–‡æœå°‹ï¼ˆæœªä¾†ï¼‰

```typescript
// ä½¿ç”¨ PostgreSQL Full-Text Search
const { data } = await supabase
  .from('projects')
  .select('*')
  .textSearch('description', 'whisper OR gemini');
```

---

## ğŸ“ è³‡æ–™é©—è­‰

### æ’å…¥å‰é©—è­‰

```typescript
// å¿…å¡«æ¬„ä½æª¢æŸ¥
if (!data.date_and_file_name || !data.description) {
  throw new Error('å¿…å¡«æ¬„ä½ç¼ºå¤±');
}

// é¡å‹æª¢æŸ¥
if (typeof data.sort_order !== 'number') {
  throw new Error('sort_order å¿…é ˆæ˜¯æ•¸å­—');
}

// JSONB æ ¼å¼é©—è­‰
if (!Array.isArray(data.image_previews)) {
  throw new Error('image_previews å¿…é ˆæ˜¯é™£åˆ—');
}
```

---

## âš¡ æ•ˆèƒ½å„ªåŒ–

### ä½¿ç”¨ç´¢å¼•

```sql
-- å·²å»ºç«‹çš„ç´¢å¼•
idx_projects_category    -- category æŸ¥è©¢
idx_projects_status      -- status æŸ¥è©¢
idx_projects_sort_order  -- æ’åºæŸ¥è©¢
idx_projects_created_at  -- æ™‚é–“æ’åº
```

**å»ºè­°**ï¼š
- ç¯©é¸æ™‚å„ªå…ˆä½¿ç”¨æœ‰ç´¢å¼•çš„æ¬„ä½
- é¿å…åœ¨ JSONB æ¬„ä½ä¸Šé€²è¡Œå¤§é‡æŸ¥è©¢

### æ‰¹é‡æ“ä½œ

```typescript
// âœ… å¥½ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥
const { data, error } = await supabaseAdmin
  .from('projects')
  .insert(multipleProjects);

// âŒ é¿å…ï¼šè¿´åœˆæ’å…¥
for (const project of projects) {
  await supabaseAdmin.from('projects').insert(project);
}
```

---

## ğŸ”§ Migration ç®¡ç†

### å»ºç«‹ Migration

```typescript
// é€é Supabase MCP
await apply_migration(projectId, 'migration_name', sqlQuery);
```

### æŸ¥çœ‹ Migrations

```typescript
// åˆ—å‡ºæ‰€æœ‰ migrations
const migrations = await list_migrations(projectId);
```

### Migration å‘½åæ…£ä¾‹

```
æ ¼å¼: YYYYMMDDHHMMSS_description
ç¯„ä¾‹: 20251028171332_create_projects_table
```

---

## ğŸ†˜ éŒ¯èª¤è™•ç†

### å¸¸è¦‹éŒ¯èª¤

```typescript
// 1. é€£æ¥å¤±æ•—
if (!supabaseAdmin) {
  return { error: 'Supabase admin client not available' };
}

// 2. æŸ¥è©¢éŒ¯èª¤
const { data, error } = await supabase.from('projects').select('*');
if (error) {
  console.error('Query failed:', error);
  return { error: error.message };
}

// 3. æ¬Šé™éŒ¯èª¤ï¼ˆRLSï¼‰
// ä½¿ç”¨ supabaseAdmin ç¹é RLS
```

---

## ğŸ“š API ä½¿ç”¨ç¯„ä¾‹

### å®Œæ•´çš„ CRUD ç¯„ä¾‹

```typescript
// app/api/projects/route.ts

import { supabaseAdmin } from '@/app/lib/supabase';

// CREATE
export async function POST(request: NextRequest) {
  const { data, error } = await supabaseAdmin
    .from('projects')
    .insert(newProject)
    .select()
    .single();
}

// READ
export async function GET() {
  const { data, error } = await supabaseAdmin
    .from('projects')
    .select('*')
    .order('sort_order');
}

// UPDATE
export async function PATCH(request: NextRequest, { params }) {
  const { data, error } = await supabaseAdmin
    .from('projects')
    .update(updates)
    .eq('id', params.id)
    .select()
    .single();
}

// DELETE
export async function DELETE(request: NextRequest, { params }) {
  const { error } = await supabaseAdmin
    .from('projects')
    .delete()
    .eq('id', params.id);
}
```

---

## ğŸ”„ å¾ Blob é·ç§»çš„å·®ç•°

### ä¸»è¦è®Šæ›´

| æ“ä½œ | Blob ç‰ˆæœ¬ | Supabase ç‰ˆæœ¬ |
|------|----------|--------------|
| è®€å– | `readProjectData()` | `supabase.from('projects').select()` |
| å¯«å…¥ | `writeProjectData(data)` | `supabase.from('projects').insert/update()` |
| åœ–ç‰‡ | `public/` éœæ…‹æª”æ¡ˆ | Supabase Storage |
| æ¬„ä½ | camelCase | snake_caseï¼ˆDBï¼‰ï¼ŒAPI è‡ªå‹•è½‰æ› |
| é©—è­‰ | `validateProjectData()` | PostgreSQL constraints + RLS |

### é·ç§»æª¢æŸ¥æ¸…å–®

- [ ] å°‡ `import { ... } from '@/lib/blob-storage'` æ”¹ç‚º `import { ... } from '@/app/lib/supabase'`
- [ ] å°‡æ¬„ä½åç¨±è½‰æ›ç‚º snake_case
- [ ] ä½¿ç”¨ `.from('table_name').select/insert/update/delete()` å–ä»£ Blob æ“ä½œ
- [ ] è™•ç† `{ data, error }` å›å‚³æ ¼å¼
- [ ] ç§»é™¤ `writeTimestamp` å’Œ `safetyCheck`ï¼ˆç”±è³‡æ–™åº«ç®¡ç†ï¼‰

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. æ°¸é ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢

```typescript
// âœ… å¥½ï¼šä½¿ç”¨ Supabase çš„åƒæ•¸åŒ–æŸ¥è©¢
const { data } = await supabase
  .from('projects')
  .select('*')
  .eq('id', userId);

// âŒ é¿å…ï¼šå­—ä¸²æ‹¼æ¥ SQLï¼ˆSQL injection é¢¨éšªï¼‰
await supabase.rpc('custom_function', { raw_sql: `SELECT * FROM projects WHERE id = '${userId}'` });
```

### 2. è™•ç† null å€¼

```typescript
// PostgreSQL å€åˆ† null å’Œç©ºå­—ä¸²
github: formData.github?.trim() || null  // âœ… ä½¿ç”¨ null
github: formData.github?.trim() || ''    // âŒ ä½¿ç”¨ç©ºå­—ä¸²æœƒä½”ç”¨ç©ºé–“
```

### 3. ä½¿ç”¨ JSONB é€²è¡Œéˆæ´»è³‡æ–™

```typescript
// âœ… é©åˆç”¨ JSONB çš„å ´æ™¯
- visibilityï¼ˆå‹•æ…‹æ¬„ä½ï¼‰
- image_previewsï¼ˆé™£åˆ—ï¼‰
- custom_info_sectionsï¼ˆä¸å›ºå®šçµæ§‹ï¼‰

// âŒ ä¸é©åˆç”¨ JSONB çš„å ´æ™¯
- date_and_file_nameï¼ˆéœ€è¦ç´¢å¼•ã€æ’åºï¼‰
- categoryã€statusï¼ˆéœ€è¦å¿«é€ŸæŸ¥è©¢ï¼‰
```

### 4. æ‰¹é‡æ“ä½œä½¿ç”¨äº‹å‹™

```typescript
// æ‰¹é‡æ›´æ–°æ’åº
const updates = projects.map(p => 
  supabaseAdmin
    .from('projects')
    .update({ sort_order: p.sortOrder })
    .eq('id', p.id)
);

await Promise.all(updates);
```

---

## ğŸ¯ æœªä¾†å„ªåŒ–

### çŸ­æœŸ

- [ ] åœ–ç‰‡è‡ªå‹•å„ªåŒ–ï¼ˆå£“ç¸®ã€WebPï¼‰
- [ ] å…¨æ–‡æœå°‹ï¼ˆPostgreSQL FTSï¼‰
- [ ] è³‡æ–™åº«å‚™ä»½è‡ªå‹•åŒ–

### ä¸­æœŸ

- [ ] å¤šä½¿ç”¨è€…æ”¯æ´ï¼ˆSupabase Authï¼‰
- [ ] å³æ™‚å”ä½œï¼ˆSupabase Realtimeï¼‰
- [ ] é€²éšæŸ¥è©¢ï¼ˆè¤‡åˆæ¢ä»¶ã€æ—¥æœŸç¯„åœï¼‰

### é•·æœŸ

- [ ] è³‡æ–™åˆ†æå„€è¡¨æ¿
- [ ] åœ–è¡¨è¦–è¦ºåŒ–
- [ ] API æ–‡æª”è‡ªå‹•ç”Ÿæˆ

---

**ç›¸é—œæ–‡æª”**ï¼š
- [APIè·¯ç”±æŒ‡å—.mdc](mdc:.cursor/rules/APIè·¯ç”±æŒ‡å—.mdc)
- [è³‡æ–™å®‰å…¨èˆ‡é˜²è­·.mdc](mdc:.cursor/rules/è³‡æ–™å®‰å…¨èˆ‡é˜²è­·.mdc)
- [TypeScriptæŒ‡å—.mdc](mdc:.cursor/rules/TypeScriptæŒ‡å—.mdc)
