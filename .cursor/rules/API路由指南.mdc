---
globs: app/api/**/*.ts
---

# API 路由指南

## 路由結構

所有 API 路由位於 `app/api/` 目錄，使用 Next.js App Router 的 Route Handlers。

### 標準路由模式

```typescript
import { NextRequest, NextResponse } from 'next/server';

export const revalidate = 0; // 禁用快取
export const dynamic = 'force-dynamic'; // 強制動態渲染

export async function GET(request: NextRequest) {
  // GET 處理邏輯
}

export async function POST(request: NextRequest) {
  // POST 處理邏輯
}
```

## 認證機制

### 管理員認證

所有寫入操作（POST、PATCH、DELETE）需要管理員權限：

```typescript
const password = request.headers.get('x-admin-password');
if (!password || password !== process.env.ADMIN_PASSWORD) {
  return NextResponse.json({ error: '未授權訪問' }, { status: 401 });
}
```

### 公開讀取

GET 請求預設為公開，無需認證。如需管理員模式：
- 查詢參數：`?admin=true`
- 標頭：`x-admin-password`

## Supabase 使用

### 客戶端選擇

- **公開操作**：使用 `supabase`（受 RLS 限制）
- **管理員操作**：使用 `supabaseAdmin`（繞過 RLS）

```typescript
import { supabase, supabaseAdmin } from '@/lib/supabase';

// 公開查詢
const { data } = await supabase.from('projects').select('*');

// 管理員操作
if (!supabaseAdmin) {
  return NextResponse.json({ error: 'Admin client not available' }, { status: 500 });
}
const { data } = await supabaseAdmin.from('projects').insert(...);
```

### 資料格式轉換

資料庫使用 `snake_case`，API 回應使用 `camelCase`：

```typescript
// 插入：camelCase → snake_case
const dbData = {
  date_and_file_name: formData.dateAndFileName,
  image_previews: formData.imagePreviews,
};

// 查詢：snake_case → camelCase
const responseData = {
  dateAndFileName: dbData.date_and_file_name,
  imagePreviews: dbData.image_previews,
};
```

## 錯誤處理

標準錯誤回應格式：

```typescript
try {
  // 操作邏輯
} catch (error) {
  console.error('Operation failed:', error);
  return NextResponse.json(
    { 
      error: '操作失敗', 
      details: error instanceof Error ? error.message : 'Unknown error' 
    },
    { status: 500 }
  );
}
```

## API 端點列表

### 專案管理
- `GET /api/projects` - 獲取專案列表
- `POST /api/projects` - 新增專案
- `GET /api/projects/[id]` - 獲取單一專案
- `PATCH /api/projects/[id]` - 更新專案
- `DELETE /api/projects/[id]` - 刪除專案
- `POST /api/projects/reorder` - 重新排序

### 圖片管理
- `GET /api/images` - 列出所有圖片
- `POST /api/images` - 上傳圖片
- `POST /api/images/rename` - 重命名圖片
- `POST /api/images/delete` - 刪除圖片
- `POST /api/images/check-references` - 檢查圖片引用

### 設定管理
- `GET /api/settings/ui-display` - 獲取 UI 設定
- `PUT /api/settings/ui-display` - 更新 UI 設定
- `POST /api/settings/reset-ui` - 重置 UI 設定

### 身份驗證
- `POST /api/auth/login` - 管理員登入

## 快取策略

所有 API 路由應設定：
```typescript
export const revalidate = 0;
export const dynamic = 'force-dynamic';
```

確保資料即時更新，不使用 Next.js 快取。
