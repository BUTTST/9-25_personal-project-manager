---
globs: "app/api/**/*.ts"
---
# API è·¯ç”±æŒ‡å—

> ğŸ“… æ›´æ–°æ—¥æœŸï¼š2025-10-28  
> ğŸ”„ ç‰ˆæœ¬ï¼šv2.0ï¼ˆSupabase ç‰ˆæœ¬ï¼‰

## è·¯ç”±çµæ§‹

[app/api/](mdc:app/api/) ä¸­çš„ API è·¯ç”±éµå¾ª Next.js App Router çš„æ…£ä¾‹ï¼š
- æ¯å€‹è·¯ç”±éƒ½æ˜¯ä¸€å€‹ `route.ts` æª”æ¡ˆ
- åŒ¯å‡ºå‘½åå‡½æ•¸ï¼š`GET`ã€`POST`ã€`PATCH`ã€`DELETE`
- ä½¿ç”¨ 'next/server' ä¸­çš„ `NextRequest` å’Œ `NextResponse`

## é©—è­‰

éœ€è¦ç®¡ç†å“¡æ¬Šé™çš„ API è·¯ç”±å¿…é ˆé©—è­‰å¯†ç¢¼ï¼š
```typescript
export async function POST(request: NextRequest) {
  // å¾æ¨™é ­é©—è­‰ç®¡ç†å“¡å¯†ç¢¼
  const password = request.headers.get('x-admin-password');
  if (!password || password !== process.env.ADMIN_PASSWORD) {
    return NextResponse.json({ error: 'æœªæˆæ¬Š' }, { status: 401 });
  }
  
  // æª¢æŸ¥ Supabase admin client
  if (!supabaseAdmin) {
    return NextResponse.json({ error: 'Supabase admin client not available' }, { status: 500 });
  }
  
  // ç¹¼çºŒåŸ·è¡Œç®¡ç†å“¡æ“ä½œ
}
```

## è³‡æ–™å­˜å–æ¨¡å¼

### ä½¿ç”¨ Supabase Client

```typescript
import { supabase, supabaseAdmin } from '@/app/lib/supabase';

// å…¬é–‹è³‡æ–™ï¼šä½¿ç”¨ supabaseï¼ˆå— RLS é™åˆ¶ï¼‰
const { data, error } = await supabase
  .from('projects')
  .select('*')
  .eq('hidden', false);

// ç®¡ç†å“¡æ“ä½œï¼šä½¿ç”¨ supabaseAdminï¼ˆç¹é RLSï¼‰
const { data, error } = await supabaseAdmin
  .from('projects')
  .select('*');
```

### CRUD æ“ä½œ

```typescript
// CREATE
const { data, error } = await supabaseAdmin
  .from('projects')
  .insert(newProject)
  .select()
  .single();

// READ
const { data, error } = await supabaseAdmin
  .from('projects')
  .select('*')
  .eq('id', projectId)
  .single();

// UPDATE
const { data, error } = await supabaseAdmin
  .from('projects')
  .update(updates)
  .eq('id', projectId)
  .select()
  .single();

// DELETE
const { error } = await supabaseAdmin
  .from('projects')
  .delete()
  .eq('id', projectId);
```

## æ¬„ä½åç¨±è½‰æ›

### è³‡æ–™åº« â†” API è½‰æ›

```typescript
// è³‡æ–™åº«ä½¿ç”¨ snake_case
// å‰ç«¯ API ä½¿ç”¨ camelCase

// DB â†’ Frontendï¼ˆåœ¨ GET å›æ‡‰ä¸­ï¼‰
const formatForFrontend = (dbRow: any) => ({
  dateAndFileName: dbRow.date_and_file_name,
  statusNote: dbRow.status_note,
  publicNote: dbRow.public_note,
  developerNote: dbRow.developer_note,
  imagePreviews: dbRow.image_previews,
  imagePreviewMode: dbRow.image_preview_mode,
  customInfoSections: dbRow.custom_info_sections,
  documentMeta: dbRow.document_meta,
  sortOrder: dbRow.sort_order,
  createdAt: new Date(dbRow.created_at).getTime(),
  updatedAt: new Date(dbRow.updated_at).getTime(),
});

// Frontend â†’ DBï¼ˆåœ¨ POST/PATCH è«‹æ±‚ä¸­ï¼‰
const formatForDatabase = (apiData: any) => ({
  date_and_file_name: apiData.dateAndFileName,
  status_note: apiData.statusNote || null,
  public_note: apiData.publicNote || null,
  developer_note: apiData.developerNote || null,
  image_previews: apiData.imagePreviews || [],
  image_preview_mode: apiData.imagePreviewMode || 'grid',
  custom_info_sections: apiData.customInfoSections || [],
  document_meta: apiData.documentMeta || null,
  sort_order: apiData.sortOrder || 0,
});
```

## éŒ¯èª¤è™•ç†

### æ¨™æº–éŒ¯èª¤è™•ç†æ¨¡å¼

```typescript
export async function POST(request: NextRequest) {
  try {
    // 1. é©—è­‰æ¬Šé™
    const password = request.headers.get('x-admin-password');
    if (!password || password !== process.env.ADMIN_PASSWORD) {
      return NextResponse.json({ error: 'æœªæˆæ¬Šè¨ªå•' }, { status: 401 });
    }

    // 2. é©—è­‰è¼¸å…¥
    const body = await request.json();
    if (!body.requiredField) {
      return NextResponse.json({ error: 'ç¼ºå°‘å¿…å¡«æ¬„ä½' }, { status: 400 });
    }

    // 3. åŸ·è¡Œæ“ä½œ
    const { data, error } = await supabaseAdmin
      .from('table_name')
      .insert(body);

    // 4. è™•ç†è³‡æ–™åº«éŒ¯èª¤
    if (error) {
      console.error('Database operation failed:', error);
      return NextResponse.json(
        { error: 'æ“ä½œå¤±æ•—', details: error.message },
        { status: 500 }
      );
    }

    // 5. æˆåŠŸå›æ‡‰
    return NextResponse.json({ success: true, data });
    
  } catch (error) {
    // 6. æ•ç²æ„å¤–éŒ¯èª¤
    console.error('Unexpected error:', error);
    return NextResponse.json(
      { error: 'ä¼ºæœå™¨éŒ¯èª¤', details: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    );
  }
}
```

### ç‹€æ…‹ç¢¼æ…£ä¾‹

| ç‹€æ…‹ç¢¼ | èªªæ˜ | ä½¿ç”¨æ™‚æ©Ÿ |
|-------|------|---------|
| 200 | OK | æˆåŠŸçš„ GET/PATCH/DELETE |
| 201 | Created | æˆåŠŸçš„ POSTï¼ˆæ–°å¢ï¼‰ |
| 400 | Bad Request | è¼¸å…¥é©—è­‰å¤±æ•— |
| 401 | Unauthorized | å¯†ç¢¼é©—è­‰å¤±æ•— |
| 403 | Forbidden | æ¬Šé™ä¸è¶³ |
| 404 | Not Found | è³‡æºä¸å­˜åœ¨ |
| 500 | Internal Server Error | ä¼ºæœå™¨éŒ¯èª¤ |
| 503 | Service Unavailable | Supabase é€£æ¥å¤±æ•— |

## Storage æ“ä½œ

### åœ–ç‰‡ä¸Šå‚³

```typescript
import { uploadImage } from '@/app/lib/storage';

export async function POST(request: NextRequest) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  
  const result = await uploadImage(file);
  
  if (!result.success) {
    return NextResponse.json({ error: result.error }, { status: 400 });
  }
  
  return NextResponse.json({ url: result.url });
}
```

### åœ–ç‰‡åˆªé™¤

```typescript
import { deleteImage, checkImageReferences } from '@/app/lib/storage';

export async function POST(request: NextRequest) {
  const { filename } = await request.json();
  
  // æª¢æŸ¥å¼•ç”¨
  const refResult = await checkImageReferences(filename);
  if (refResult.references && refResult.references.length > 0) {
    return NextResponse.json({
      error: 'Image is in use',
      references: refResult.references
    }, { status: 400 });
  }
  
  // åˆªé™¤
  const result = await deleteImage(filename);
  return NextResponse.json({ success: result.success });
}
```

## å¿«å–æ§åˆ¶

### ç¦ç”¨å¿«å–ï¼ˆå‹•æ…‹è³‡æ–™ï¼‰

```typescript
// åœ¨æª”æ¡ˆé ‚éƒ¨åŠ å…¥
export const revalidate = 0;
export const dynamic = 'force-dynamic';
```

### å•Ÿç”¨å¿«å–ï¼ˆéœæ…‹è³‡æ–™ï¼‰

```typescript
// å¿«å– 60 ç§’
export const revalidate = 60;
```

## å®Œæ•´ API ç«¯é»åˆ—è¡¨

### Projectsï¼ˆå°ˆæ¡ˆç®¡ç†ï¼‰

```
GET    /api/projects              # åˆ—å‡ºå°ˆæ¡ˆ
GET    /api/projects?admin=true   # åˆ—å‡ºæ‰€æœ‰å°ˆæ¡ˆï¼ˆç®¡ç†å“¡ï¼‰
POST   /api/projects              # æ–°å¢å°ˆæ¡ˆ
GET    /api/projects/[id]         # ç²å–å–®ä¸€å°ˆæ¡ˆ
PATCH  /api/projects/[id]         # æ›´æ–°å°ˆæ¡ˆ
DELETE /api/projects/[id]         # åˆªé™¤å°ˆæ¡ˆ
POST   /api/projects/reorder      # æ‰¹é‡æ’åº
```

### Imagesï¼ˆåœ–ç‰‡ç®¡ç†ï¼‰â­ NEW

```
GET    /api/images                     # åˆ—å‡ºæ‰€æœ‰åœ–ç‰‡
POST   /api/images                     # ä¸Šå‚³åœ–ç‰‡
POST   /api/images/rename              # é‡å‘½ååœ–ç‰‡
POST   /api/images/delete              # åˆªé™¤åœ–ç‰‡
POST   /api/images/check-references    # æª¢æŸ¥å¼•ç”¨
```

### Settingsï¼ˆè¨­å®šç®¡ç†ï¼‰

```
GET    /api/settings/ui-display   # ç²å– UI è¨­å®š
PUT    /api/settings/ui-display   # æ›´æ–° UI è¨­å®š
POST   /api/settings/reset-ui     # é‡ç½® UI è¨­å®š
```

### Adminï¼ˆç®¡ç†å·¥å…·ï¼‰

```
GET    /api/admin/diagnose        # ç³»çµ±è¨ºæ–·
POST   /api/admin/import-data     # æ‰¹é‡åŒ¯å…¥
```

### Authï¼ˆé©—è­‰ï¼‰

```
POST   /api/auth/login            # ç®¡ç†å“¡ç™»å…¥
```

---

**ç›¸é—œæ–‡æª”**ï¼š
- [è³‡æ–™ç®¡ç†æŒ‡å—.mdc](mdc:.cursor/rules/è³‡æ–™ç®¡ç†æŒ‡å—.mdc)
- [é©—è­‰èˆ‡æˆæ¬Š.mdc](mdc:.cursor/rules/é©—è­‰èˆ‡æˆæ¬Š.mdc)
- [TypeScriptæŒ‡å—.mdc](mdc:.cursor/rules/TypeScriptæŒ‡å—.mdc)
