# 📊 資料庫安全性迭代記錄

> 根據 Vercel Blob 使用經驗與生產環境反饋總結的資料安全防護演進

---

## 🚨 第一階段：初期問題（已解決）

### 問題 1：部署時資料被重置
**表現**：每次推送新版本後，用戶新增的專案全部消失，系統恢復到範例資料。

**根本原因**：
- 自動初始化 API 端點（`GET /api/initialize`）在啟動時檢查資料是否為空
- 冷啟動延遲導致 Blob 讀取超時，被誤判為空資料
- 系統自動用 `forceWrite=true` 覆蓋現有資料

**解決**：停用自動初始化端點，改為需要管理員明確授權的 POST 操作

---

### 問題 2：讀取失敗被當成空資料
**表現**：任何讀取錯誤（網路、權限、格式錯誤）都會返回預設空資料，觸發誤判初始化。

**根本原因**：
- `readProjectData()` 的 `catch` 區塊直接返回 `defaultProjectData`
- 無法區分「檔案不存在」與「讀取失敗」

**解決**：改為拋出 `ProjectDataError`，讓上層 API 攔截並返回錯誤訊息

---

### 問題 3：缺乏多層驗證保護
**表現**：寫入操作只檢查資料是否為空，沒有完整驗證鏈

**根本原因**：設計簡化過度，沒有考慮到邊界情況

**解決**：實施三層驗證（資料完整性 → 空資料檢查 → 安全鎖標記）

---

## ✅ 第二階段：本次改進內容

### 改進 1：強化讀取邏輯與錯誤處理

**做法**：
- 新增 `ProjectDataError` 錯誤類別，區分不同的失敗情況
  - `LOCAL_BACKUP_MODE_ENABLED`：偵測到本地備份模式
  - `BLOB_LIST_FAILED`：無法列出 Blob 檔案
  - `BLOB_FETCH_FAILED`：無法讀取 Blob 內容
  - `BLOB_PARSE_FAILED`：JSON 解析失敗
  - `BLOB_SCHEMA_INVALID`：資料格式驗證失敗

- 本地開發環境優雅降級：若無 `BLOB_READ_WRITE_TOKEN`，使用預設空資料繼續開發，而非拋錯
- 生產環境嚴格模式：讀取失敗直接拋錯，讓前端顯示「暫時無法操作」

**效果**：
- 開發者在本地無需設定 Vercel Blob token 即可運行
- 生產環境讀取失敗會被明確攔截，不會誤觸初始化

---

### 改進 2：防止本地備份模式意外覆蓋

**做法**：
- 檢測環境變數 `NEXT_PUBLIC_USE_LOCAL_BACKUP`
- 若該變數為 `true`，所有寫入操作直接拋出 `ProjectDataError`，回傳 503 錯誤
- 後台顯示醒目警告，禁止任何寫入操作

**效果**：
- 即使開發者忘記關閉本地備份模式，系統也會自動鎖定寫入
- 避免把舊快照覆蓋回雲端

---

### 改進 3：統一 API 端點的錯誤回應格式

**做法**：
- 所有 API 端點（專案 CRUD、排序、設定儲存）捕捉到錯誤時，統一回傳格式：
  ```
  {
    error: "簡短的中文說明",
    details: "英文錯誤訊息",
    translatedMessage: "⚠️ 詳細的繁中翻譯"
  }
  ```
- 讀取失敗時用 503 表示「暫時無法操作」
- 寫入失敗時用 500 表示「伺服器錯誤」

**效果**：
- 開發者可以快速理解問題（透過繁中翻譯）
- 其他開發者也能看到原始英文錯誤代碼進行除錯

---

### 改進 4：簡化密碼管理介面

**做法**：
- 移除後台「密碼管理」分頁及所有密碼相關 UI
- 保留管理員登入驗證功能（這是必要的）
- 批量導入邏輯改為僅處理專案列表，不再導入密碼

**效果**：
- UI 更簡潔，焦點集中在專案管理
- 減少不必要的功能複雜度

---

### 改進 5：本地開發模式優化

**做法**：
- Blob 寫入失敗時，不拋錯，而是返回模擬的寫入結果
- 記錄警告訊息：「本地開發模式，數據變更僅在記憶體中」
- 開發者可以正常進行本地測試而不會被 Blob 限制打斷

**效果**：
- 開發流程更流暢
- 在本地沒有配置 Vercel 也能完整測試功能

---

## 📋 目前安全防護機制

| 防護層 | 機制 | 觸發條件 |
|------|------|--------|
| **第一層** | 資料完整性驗證 | 讀取時檢查必要欄位 |
| **第二層** | 空資料保護 | 檢測到空資料且現有資料非空時拋錯 |
| **第三層** | 安全鎖標記 | 記錄每次寫入是否經過驗證（`VERIFIED` or `FORCED`） |
| **第四層** | 本地備份模式鎖定 | `USE_LOCAL_BACKUP=true` 時禁止所有寫入 |
| **第五層** | 管理員授權驗證 | 所有寫入操作都需驗證密碼 |

---

## 📈 對比表

| 方面 | 改進前 | 改進後 |
|------|--------|--------|
| 讀取失敗處理 | 靜默返回預設值 | 拋錯並返回詳細訊息 |
| 本地備份模式 | 無防護，易覆蓋生產資料 | 自動鎖定所有寫入 |
| 錯誤訊息 | 英文且簡略 | 雙語訊息，含原始錯誤碼 |
| 密碼管理 | 冗長的 UI 分頁 | 完全移除，精簡化 |
| 本地開發 | 需完整配置 Vercel | 優雅降級，無需 token |

---

## 🛡️ 核心安全原則（不可妥協）

### 原則 1：永不自動覆蓋
✅ **執行**：管理員明確授權的操作
❌ **禁止**：在啟動、錯誤処理、或中間件中自動寫入

### 原則 2：讀取失敗拋錯誤
✅ **執行**：向上拋出詳細錯誤，讓前端顯示警告
❌ **禁止**：靜默使用預設值繼續運行

### 原則 3：多層驗證
✅ **執行**：完整性 → 空資料檢查 → 授權驗證
❌ **禁止**：單一驗證點或無驗證

### 原則 4：區分情況
✅ **執行**：明確區分「檔案不存在」vs「讀取失敗」vs「資料為空」
❌ **禁止**：將三種情況混為一談

---

## 🎯 實施成果

**資料安全等級**：從「易丟失」升級到「多層保護」

**具體成果**：
- ✅ 讀取失敗時明確反饋，不再誤觸初始化
- ✅ 本地備份模式自動鎖定寫入，防止覆蓋生產資料
- ✅ 所有 API 端點使用統一的雙語錯誤格式
- ✅ 開發者在本地無需 Vercel 配置即可運行
- ✅ 後台 UI 更簡潔，移除非必要功能

---

## 📝 開發者須知

### 本地開發
- 無需設定 `BLOB_READ_WRITE_TOKEN`，系統會自動優雅降級
- 本地變更只在記憶體中，刷新頁面後消失（正常行為）

### 部署前檢查清單
- [ ] 確認 `.env` 中 `NEXT_PUBLIC_USE_LOCAL_BACKUP` 為空或 `false`
- [ ] 確認 `ADMIN_PASSWORD` 已設定
- [ ] 本地測試完整的增刪改查流程
- [ ] 檢查控制台是否有任何警告訊息

### 緊急還原
- 若資料被誤覆蓋，可透過後台管理頁面的「批量匯入」功能還原已備份資料
- 無法自動回滾，必須手動匯入

---

## 🎓 設計思路

這次改進的核心理念：
1. **防禦優先於便利**：寧可多一層檢查，也不要冒險自動化
2. **明確優於隱含**：錯誤必須清楚呈現，不能靜默失敗
3. **開發友善於繁瑣**：本地開發無需複雜配置
4. **生產謹慎於靈活**：生產環境嚴格把關，不允許有灰色地帶

---

**最後更新**：2025-10-22
**狀態**：✅ 全面實施（第二階段）
**下次考慮**：實施自動備份機制、審計日誌系統
