# 階段 2：資料遷移操作

> ⏱️ 預估時間：1-1.5 小時  
> 🎯 目標：將現有 JSON 資料和圖片遷移至 Supabase  
> 📝 難度：⭐⭐

---

## 📋 本階段目標

完成後，您將達成：
- ✅ 所有專案資料已匯入 Supabase
- ✅ 所有密碼資料已匯入 Supabase
- ✅ 所有設定已匯入 Supabase
- ✅ 30 張圖片已上傳至 Supabase Storage
- ✅ 資料完整性已驗證

---

## 🗂️ 步驟 1：準備現有資料

### 1.1 下載當前 Blob 資料

**從 Vercel 控制台**：

```
1. 前往您的專案
2. 點擊 "Storage" 選項卡
3. 點擊 "Blob" storage
4. 找到 "project-data.json"
5. 點擊右側的 "..." 選單
6. 選擇 "Download"（下載）
7. 儲存到本地
```

**或使用 API 下載**（如果控制台找不到）：

```bash
# 在您的專案目錄執行
# 建立臨時腳本 download-blob-data.js

node download-blob-data.js
```

**download-blob-data.js 內容**：

```javascript
import { list } from '@vercel/blob';
import fs from 'fs';

async function downloadData() {
  try {
    const { blobs } = await list();
    const dataBlob = blobs.find(blob => blob.pathname === 'project-data.json');
    
    if (!dataBlob) {
      console.error('找不到 project-data.json');
      return;
    }

    const response = await fetch(dataBlob.url);
    const data = await response.json();
    
    // 儲存到本地
    fs.writeFileSync(
      './migration-data/project-data-backup.json',
      JSON.stringify(data, null, 2)
    );
    
    console.log('✅ 資料已下載到 migration-data/project-data-backup.json');
  } catch (error) {
    console.error('下載失敗:', error);
  }
}

downloadData();
```

### 1.2 檢視資料結構

**開啟 JSON 檔案**，確認資料結構：

```json
{
  "projects": [
    {
      "id": "uuid-string",
      "dateAndFileName": "10-28 專案名稱",
      "description": "專案說明",
      "category": "important",
      "status": "in-progress",
      "github": "https://github.com/...",
      // ... 更多欄位
    }
  ],
  "passwords": [
    {
      "id": "uuid-string",
      "platform": "GitHub",
      "account": "username",
      "password": "password",
      // ...
    }
  ],
  "settings": {
    "showToggleControls": true,
    // ...
  },
  "metadata": {
    // ...
  }
}
```

---

## 🔄 步驟 2：資料轉換（JSON → PostgreSQL）

### 2.1 建立轉換腳本

**建立檔案**：`migration-data/convert-to-sql.js`

```javascript
import fs from 'fs';

// 讀取 JSON 資料
const data = JSON.parse(
  fs.readFileSync('./project-data-backup.json', 'utf8')
);

// 轉換函數
function escapeString(str) {
  if (!str) return null;
  return str.replace(/'/g, "''").replace(/\\/g, '\\\\');
}

function convertToSQL() {
  let sql = '-- 資料遷移 SQL\n\n';

  // 1. 轉換 Projects
  sql += '-- 匯入專案資料\n';
  data.projects.forEach(project => {
    const visibility = JSON.stringify(project.visibility || {});
    const imagePreviews = JSON.stringify(project.imagePreviews || []);
    const customInfoSections = JSON.stringify(project.customInfoSections || []);
    const documentMeta = project.documentMeta ? JSON.stringify(project.documentMeta) : null;

    sql += `INSERT INTO projects (
      id, date_and_file_name, description, category, status,
      github, vercel, deployment, path, status_note, public_note, developer_note,
      visibility, image_previews, image_preview_mode, custom_info_sections, document_meta,
      featured, hidden, sort_order, created_at, updated_at
    ) VALUES (
      '${project.id}',
      '${escapeString(project.dateAndFileName)}',
      '${escapeString(project.description)}',
      '${project.category}',
      '${project.status}',
      ${project.github ? `'${escapeString(project.github)}'` : 'NULL'},
      ${project.vercel ? `'${escapeString(project.vercel)}'` : 'NULL'},
      ${project.deployment ? `'${escapeString(project.deployment)}'` : 'NULL'},
      ${project.path ? `'${escapeString(project.path)}'` : 'NULL'},
      ${project.statusNote ? `'${escapeString(project.statusNote)}'` : 'NULL'},
      ${project.publicNote ? `'${escapeString(project.publicNote)}'` : 'NULL'},
      ${project.developerNote ? `'${escapeString(project.developerNote)}'` : 'NULL'},
      '${escapeString(visibility)}'::jsonb,
      '${escapeString(imagePreviews)}'::jsonb,
      '${project.imagePreviewMode || 'grid'}',
      '${escapeString(customInfoSections)}'::jsonb,
      ${documentMeta ? `'${escapeString(documentMeta)}'::jsonb` : 'NULL'},
      ${project.featured || false},
      ${project.hidden || false},
      ${project.sortOrder || 0},
      '${new Date(project.createdAt).toISOString()}',
      '${new Date(project.updatedAt).toISOString()}'
    );\n\n`;
  });

  // 2. 轉換 Passwords
  sql += '\n-- 匯入密碼資料\n';
  data.passwords.forEach(pwd => {
    sql += `INSERT INTO passwords (
      id, platform, account, password, created_at, updated_at
    ) VALUES (
      '${pwd.id}',
      '${escapeString(pwd.platform)}',
      '${escapeString(pwd.account)}',
      '${escapeString(pwd.password)}',
      '${new Date(pwd.createdAt).toISOString()}',
      '${new Date(pwd.updatedAt).toISOString()}'
    );\n`;
  });

  // 3. 轉換 Settings
  sql += '\n-- 更新設定資料\n';
  const appSettings = JSON.stringify(data.settings);
  sql += `UPDATE settings 
    SET value = '${escapeString(appSettings)}'::jsonb 
    WHERE key = 'app_settings';\n`;

  if (data.settings.uiDisplay) {
    const uiDisplay = JSON.stringify(data.settings.uiDisplay);
    sql += `UPDATE settings 
      SET value = '${escapeString(uiDisplay)}'::jsonb 
      WHERE key = 'ui_display';\n`;
  }

  // 儲存 SQL 檔案
  fs.writeFileSync('./migration-import.sql', sql);
  console.log('✅ SQL 檔案已生成：migration-import.sql');
  console.log(`📊 統計：`);
  console.log(`   - 專案: ${data.projects.length} 筆`);
  console.log(`   - 密碼: ${data.passwords.length} 筆`);
}

convertToSQL();
```

### 2.2 執行轉換

```bash
# 建立資料夾
mkdir migration-data

# 將下載的 JSON 放入此資料夾
# 將轉換腳本放入此資料夾

# 執行轉換
cd migration-data
node convert-to-sql.js

# 應該看到：
# ✅ SQL 檔案已生成：migration-import.sql
# 📊 統計：
#    - 專案: X 筆
#    - 密碼: Y 筆
```

---

## 📥 步驟 3：匯入資料到 Supabase

### 3.1 使用 SQL Editor 匯入

**在 Supabase 控制台**：

```
1. 左側選單 → SQL Editor
   英文對照：SQL Editor = SQL 編輯器

2. 點擊 "New query"（新增查詢）

3. 開啟本地的 migration-import.sql 檔案

4. 複製所有內容

5. 貼到 SQL Editor

6. 點擊右下角的 "Run"（執行）

7. 等待執行完成（可能需要 10-30 秒）

8. 看到 "Success. No rows returned" 表示成功
```

### 3.2 驗證資料匯入

**檢查專案資料**：

```sql
-- 在 SQL Editor 執行

-- 檢查專案數量
SELECT COUNT(*) as project_count FROM projects;

-- 查看前 5 筆專案
SELECT id, date_and_file_name, category, status 
FROM projects 
LIMIT 5;

-- 檢查密碼數量
SELECT COUNT(*) as password_count FROM passwords;

-- 檢查設定
SELECT * FROM settings;
```

**或使用 Table Editor**：

```
1. 左側選單 → Table Editor
2. 點擊 "projects" 表
3. 應該看到所有專案資料
4. 確認資料筆數正確
5. 隨機檢查幾筆資料內容是否正確
```

---

## 📸 步驟 4：上傳圖片到 Supabase Storage

### 4.1 準備圖片檔案

**收集所有圖片**：

```
當前位置: public/前端截圖/
圖片數量: 約 30 張

需要做的:
□ 確認所有圖片都在此資料夾
□ 檢查圖片總大小（應 < 10MB）
□ 記下圖片檔名（稍後需要更新路徑）
```

### 4.2 批量上傳圖片

**方法 A：使用 Supabase 控制台（推薦）**

```
1. 前往 Storage → screenshots bucket

2. 點擊 "Upload files"（上傳檔案）

3. 選擇所有圖片（可多選）
   提示：按住 Ctrl（Windows）或 Cmd（Mac）多選

4. 點擊開啟，開始上傳

5. 等待上傳完成（約 1-2 分鐘）

6. 確認所有圖片都已上傳成功
```

**方法 B：使用上傳腳本（可選）**

建立 `migration-data/upload-images.js`：

```javascript
import { createClient } from '@supabase/supabase-js';
import fs from 'fs';
import path from 'path';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function uploadImages() {
  const imagesDir = '../public/前端截圖';
  const files = fs.readdirSync(imagesDir);
  
  console.log(`📸 準備上傳 ${files.length} 張圖片...`);

  for (const file of files) {
    if (!file.match(/\.(png|jpg|jpeg|gif|webp)$/i)) continue;

    const filePath = path.join(imagesDir, file);
    const fileBuffer = fs.readFileSync(filePath);

    console.log(`上傳中: ${file}`);

    const { data, error } = await supabase.storage
      .from('screenshots')
      .upload(file, fileBuffer, {
        contentType: `image/${path.extname(file).slice(1)}`,
        upsert: true
      });

    if (error) {
      console.error(`❌ ${file} 上傳失敗:`, error);
    } else {
      console.log(`✅ ${file} 上傳成功`);
    }
  }

  console.log('🎉 所有圖片上傳完成！');
}

uploadImages();
```

執行：

```bash
cd migration-data
node upload-images.js
```

### 4.3 獲取圖片 URL

**在 Supabase Storage 中**：

```
1. 點擊任意圖片
2. 查看右側面板
3. 複製 "Public URL"
4. URL 格式應為：
   https://[project-id].supabase.co/storage/v1/object/public/screenshots/[filename]
```

**批量生成 URL 對照表**：

建立 `migration-data/generate-image-urls.js`：

```javascript
import { createClient } from '@supabase/supabase-js';
import fs from 'fs';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function generateUrls() {
  const { data: files, error } = await supabase.storage
    .from('screenshots')
    .list();

  if (error) {
    console.error('錯誤:', error);
    return;
  }

  const mapping = {};
  files.forEach(file => {
    const { data } = supabase.storage
      .from('screenshots')
      .getPublicUrl(file.name);
    
    mapping[file.name] = data.publicUrl;
  });

  fs.writeFileSync(
    './image-url-mapping.json',
    JSON.stringify(mapping, null, 2)
  );

  console.log('✅ URL 對照表已生成：image-url-mapping.json');
}

generateUrls();
```

---

## 🔗 步驟 5：更新圖片路徑引用

### 5.1 了解路徑變更

**原本的路徑**：
```javascript
// 硬編碼在 config/image-gallery.ts
src: '/前端截圖/9-24-icon-auto-creator.png'
```

**新的路徑**：
```javascript
// 從 Supabase Storage
src: 'https://xxx.supabase.co/storage/v1/object/public/screenshots/9-24-icon-auto-creator.png'
```

### 5.2 更新資料庫中的圖片路徑

**如果專案中的 imagePreviews 使用舊路徑**：

```sql
-- 在 SQL Editor 執行
-- 將所有圖片路徑從本地路徑改為 Supabase URL

UPDATE projects
SET image_previews = jsonb_set(
  image_previews,
  '{0,src}',
  to_jsonb(
    'https://[your-project-id].supabase.co/storage/v1/object/public/screenshots/' ||
    REPLACE((image_previews->0->>'src'), '/前端截圖/', '')
  )
)
WHERE jsonb_array_length(image_previews) > 0;

-- 替換 [your-project-id] 為您的實際 project ID
```

**或使用更新腳本**（如果結構複雜）：

```javascript
// migration-data/update-image-paths.js
import { createClient } from '@supabase/supabase-js';
import fs from 'fs';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

// 讀取 URL 對照表
const urlMapping = JSON.parse(
  fs.readFileSync('./image-url-mapping.json', 'utf8')
);

async function updateImagePaths() {
  // 讀取所有專案
  const { data: projects, error } = await supabase
    .from('projects')
    .select('id, image_previews');

  if (error) {
    console.error('讀取失敗:', error);
    return;
  }

  console.log(`📝 需要更新 ${projects.length} 筆專案`);

  for (const project of projects) {
    if (!project.image_previews || project.image_previews.length === 0) {
      continue;
    }

    // 更新圖片 URL
    const updatedPreviews = project.image_previews.map(preview => {
      const filename = preview.src.split('/').pop();
      return {
        ...preview,
        src: urlMapping[filename] || preview.src
      };
    });

    // 儲存更新
    const { error: updateError } = await supabase
      .from('projects')
      .update({ image_previews: updatedPreviews })
      .eq('id', project.id);

    if (updateError) {
      console.error(`❌ 更新專案 ${project.id} 失敗:`, updateError);
    } else {
      console.log(`✅ 專案 ${project.id} 已更新`);
    }
  }

  console.log('🎉 所有圖片路徑已更新！');
}

updateImagePaths();
```

---

## ✅ 步驟 6：驗證資料完整性

### 6.1 資料數量驗證

```sql
-- 在 SQL Editor 執行

-- 1. 檢查專案總數
SELECT COUNT(*) as total_projects FROM projects;

-- 2. 按類別統計
SELECT category, COUNT(*) as count 
FROM projects 
GROUP BY category 
ORDER BY count DESC;

-- 3. 按狀態統計
SELECT status, COUNT(*) as count 
FROM projects 
GROUP BY status 
ORDER BY count DESC;

-- 4. 檢查有圖片的專案數量
SELECT COUNT(*) as projects_with_images
FROM projects
WHERE jsonb_array_length(image_previews) > 0;

-- 5. 檢查密碼數量
SELECT COUNT(*) as total_passwords FROM passwords;
```

**預期結果**：
```
✅ 專案總數應與原始 JSON 相同
✅ 各類別數量應與原始 JSON 相同
✅ 密碼數量應與原始 JSON 相同
```

### 6.2 資料內容驗證

**隨機抽查幾筆專案**：

```sql
-- 完整查看一筆專案
SELECT * FROM projects LIMIT 1;

-- 檢查特定專案
SELECT * FROM projects 
WHERE date_and_file_name LIKE '%你的專案名稱%';
```

**確認事項**：
- [ ] 中文字正常顯示（無亂碼）
- [ ] JSON 欄位格式正確
- [ ] 時間戳正確
- [ ] 所有必填欄位都有值

### 6.3 圖片驗證

**在 Supabase Storage**：

```
1. 前往 Storage → screenshots
2. 確認圖片數量（應為 30 張）
3. 隨機點擊幾張圖片
4. 點擊 "Copy URL"
5. 在瀏覽器新分頁開啟 URL
6. 確認圖片可正常顯示
```

**測試圖片 URL**：

```javascript
// 在瀏覽器 Console 測試
const testUrl = 'https://[your-project].supabase.co/storage/v1/object/public/screenshots/test.png';
fetch(testUrl)
  .then(r => r.ok ? console.log('✅ 可存取') : console.error('❌ 無法存取'))
```

---

## 📊 完成狀態總覽

### 資料遷移檢核表

#### JSON 資料
- [ ] ✅ 原始 JSON 已下載並備份
- [ ] ✅ 轉換 SQL 腳本已執行
- [ ] ✅ 專案資料已全部匯入
- [ ] ✅ 密碼資料已全部匯入
- [ ] ✅ 設定資料已匯入
- [ ] ✅ 資料數量與原始相符

#### 圖片資料
- [ ] ✅ 所有圖片已上傳 (30 張)
- [ ] ✅ 圖片可公開存取
- [ ] ✅ URL 對照表已生成
- [ ] ✅ 資料庫中的圖片路徑已更新

#### 驗證
- [ ] ✅ 資料數量統計正確
- [ ] ✅ 隨機抽查資料內容正確
- [ ] ✅ 中文字無亂碼
- [ ] ✅ 圖片可正常顯示
- [ ] ✅ JSON 欄位格式正確

---

## 🎯 下一步

恭喜完成資料遷移！您現在已經：
- ✅ 將所有專案資料遷移到 PostgreSQL
- ✅ 將所有圖片上傳到 Supabase Storage
- ✅ 更新了圖片路徑引用
- ✅ 驗證了資料完整性

**資料層已經準備好了，現在需要修改程式碼來連接新資料庫！**

👉 請繼續閱讀：`03_程式碼改造指南.md`

---

## 🆘 遇到問題？

### 常見問題

**Q: SQL 匯入時出現錯誤？**  
A: 檢查是否有特殊字元未正確轉義，可以分段執行 SQL

**Q: 圖片上傳失敗？**  
A: 確認 bucket 權限設定正確，檢查圖片格式和大小

**Q: 圖片 URL 無法存取？**  
A: 確認 bucket 的 Public 選項已勾選，檢查 Storage Policies

**Q: 資料數量不符？**  
A: 重新執行轉換腳本，確認 JSON 檔案完整

**Q: 中文出現亂碼？**  
A: 確認資料庫編碼為 UTF-8，重新執行匯入


