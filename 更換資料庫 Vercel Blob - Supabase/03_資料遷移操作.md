# 階段 2：資料遷移操作（MCP 自動化版）

> ⏱️ 實際時間：**10 分鐘**（使用 MCP）  
> 🎯 目標：將 Vercel Blob 資料自動遷移至 Supabase  
> 📝 難度：⭐（極簡單）  
> ⭐ 前提：已完成階段 1 並連接 Cursor Supabase MCP

---

## 📋 本階段目標

完成後，您將達成：
- ✅ 16 個專案已自動插入 Supabase
- ✅ 2 個密碼已自動插入 Supabase
- ✅ Settings 配置已自動更新
- ✅ 資料 100% 完整遷移
- ✅ 0 筆資料遺失

---

## 🚀 使用 MCP 自動遷移（推薦）

### 方式 A：一鍵自動遷移

**提示詞**：

```
請使用 Supabase MCP 幫我遷移資料：

1. 讀取 本地備份/2025-10-28(晚上五點) 專案管理平台_project-data.json
2. 將所有專案資料插入 Supabase projects 表
3. 將密碼資料插入 passwords 表
4. 更新 settings 表的 ui_display 配置
5. 驗證插入的資料筆數

請完成後給我報告。
```

**AI 會執行**：
1. 自動讀取 JSON 檔案
2. 轉換欄位名稱（camelCase → snake_case）
3. 批量插入資料到 Supabase
4. 驗證資料完整性
5. 提供遷移報告

**預期時間**：3-5 分鐘

---

### 方式 B：分步驟遷移（更多控制）

#### 步驟 1：插入專案資料

**提示詞**：

```
請從 本地備份/最新備份.json 讀取專案資料，
並使用 Supabase MCP 插入到 projects 表。

注意：
- 需要轉換欄位名稱為 snake_case
- ID 類型已調整為 text（支援現有格式）
- 請分批插入避免 SQL 過長
```

#### 步驟 2：插入密碼資料

**提示詞**：

```
請插入 passwords 資料到 Supabase。
```

#### 步驟 3：更新設定

**提示詞**：

```
請更新 settings 表的 ui_display 配置，
包含 15 個 filters 和 12 個 statistics。
```

---

## 📊 實際遷移成果（已完成範例）

### 資料統計

```yaml
Projects 表:
  ✅ 插入：16 筆
  ✅ 欄位：22 個（完整）
  ✅ 索引：4 個（已建立）
  ✅ RLS：已啟用

Passwords 表:
  ✅ 插入：2 筆
  ✅ 欄位：6 個（完整）
  ✅ RLS：完全禁止前端訪問

Settings 表:
  ✅ 更新：ui_display 配置
  ✅ Filters：15 個
  ✅ Statistics：12 個
```

### Migration 記錄

```yaml
已應用的 Migrations:
  ✅ 20251028171332 - create_projects_table
  ✅ 20251028171344 - create_passwords_table
  ✅ 20251028171357 - create_settings_table
  ✅ alter_id_to_text - ID 類型調整
  ✅ insert_projects_batch - 資料插入
```

---

## 🔍 資料驗證

### 使用 MCP 驗證

**提示詞**：

```
請使用 Supabase MCP 驗證資料：

1. 查詢 projects 表的筆數
2. 查詢 passwords 表的筆數
3. 查詢 settings 表的內容
4. 確認所有資料是否正確遷移
```

**預期結果**：

```
✅ projects: 16 筆
✅ passwords: 2 筆
✅ settings: 2 筆（app_settings, ui_display）
```

---

## 🖼️ 圖片遷移（使用管理後台）

### 手動上傳圖片

**為什麼不用 MCP？**
- MCP 無法訪問本地檔案系統
- 無法讀取 public/前端截圖/ 的圖片
- 需要透過管理後台介面上傳

**操作步驟**（5-10 分鐘）：

```
1. 啟動本地開發環境:
   npm run dev

2. 前往管理後台:
   http://localhost:3000/admin

3. 點擊「圖片管理」tab

4. 拖拽上傳:
   - 開啟檔案總管: public/前端截圖/
   - 全選 26 張圖片
   - 拖拽到上傳區
   - 點擊「開始上傳」

5. 等待完成:
   - 每張圖片約 5-10 秒
   - 總計 2-5 分鐘
   - 顯示上傳進度

6. 驗證:
   - 圖片庫顯示 26 個圖片
   - 可以搜尋、預覽圖片
```

### 圖片策略選擇

**選項 A：完全遷移到 Supabase**（推薦）
```yaml
優點:
  ✅ 統一管理
  ✅ CDN 加速
  ✅ 支援檔名編輯
  ✅ 引用追蹤

步驟:
  1. 上傳所有圖片到 Supabase
  2. 批量更新專案的 image_previews 路徑
  3. 刪除 public/前端截圖/（可選）
```

**選項 B：保留 public 圖片**（保守）
```yaml
優點:
  ✅ 無需更新路徑
  ✅ Git 版本控制
  ✅ 無額外成本

限制:
  ⚠️ 無法在後台編輯
  ⚠️ 需要透過 Git 推送
  ⚠️ 混合管理較複雜
```

**本專案採用**：選項 B（圖片保留在 public，新圖片使用 Supabase）

---

## ✅ 完成檢核

### 資料完整性檢查

**在 Supabase Dashboard**：

```
1. Table Editor → projects
   □ 16 rows（16 筆資料）
   □ 22 columns（22 個欄位）
   
2. Table Editor → passwords
   □ 2 rows
   □ 6 columns
   
3. Table Editor → settings
   □ 2 rows（app_settings, ui_display）
```

### 資料內容驗證

**使用 Supabase SQL Editor**：

```sql
-- 驗證專案
SELECT 
  COUNT(*) as total,
  COUNT(CASE WHEN category = 'important' THEN 1 END) as important,
  COUNT(CASE WHEN category = 'secondary' THEN 1 END) as secondary
FROM projects;

-- 驗證設定
SELECT key, 
  jsonb_array_length(value->'filters') as filter_count,
  jsonb_array_length(value->'statistics') as stat_count
FROM settings 
WHERE key = 'ui_display';
```

**預期結果**：
```
total: 16
important: X 個
secondary: Y 個
filter_count: 15
stat_count: 12
```

---

## 🎯 下一步

恭喜完成資料遷移！

所有資料已成功從 Vercel Blob 遷移到 Supabase。

👉 **接下來**：進行程式碼改造  
📄 **詳細指南**：`04_程式碼改造指南.md`

---

## 🆘 常見問題

**Q: MCP 插入資料失敗？**  
A: 檢查 ID 類型是否已調整為 text（ALTER TABLE projects ALTER COLUMN id TYPE text）

**Q: 資料筆數不對？**  
A: 檢查是否有重複插入，使用 `SELECT COUNT(*) FROM projects` 驗證

**Q: Settings 配置錯誤？**  
A: 檢查 JSONB 格式是否正確，filters 和 statistics 是否為陣列

**Q: 圖片上傳失敗？**  
A: 檢查 bucket 名稱是否為 `project-images`，以及中文檔名是否已處理

---

**總結**：使用 MCP 讓資料遷移從 1-1.5 小時縮短到 5 分鐘！⚡
