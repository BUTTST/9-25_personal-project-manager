# 階段 3：程式碼改造指南

> ⏱️ 預估時間：1.5-2 小時  
> 🎯 目標：修改程式碼以連接 Supabase 資料庫  
> 📝 難度：⭐⭐⭐⭐

---

## 📋 本階段目標

完成後，您將達成：
- ✅ 安裝 Supabase 客戶端套件
- ✅ 建立資料存取層 (`app/lib/supabase.ts`)
- ✅ 修改 7 個 API 路由檔案
- ✅ 更新環境變數配置
- ✅ 本地測試所有功能正常

---

## 📦 步驟 1：安裝依賴套件

### 1.1 安裝 Supabase 客戶端

```bash
# 在專案根目錄執行
npm install @supabase/supabase-js

# 如果使用 yarn
yarn add @supabase/supabase-js

# 如果使用 pnpm
pnpm add @supabase/supabase-js
```

**等待安裝完成**（約 10-30 秒）

### 1.2 驗證安裝

```bash
# 檢查 package.json
cat package.json | grep supabase

# 應該看到：
# "@supabase/supabase-js": "^2.x.x"
```

---

## 🔧 步驟 2：建立 Supabase 客戶端

### 2.1 建立新檔案

**檔案路徑**：`app/lib/supabase.ts`

**完整內容**：

```typescript
import { createClient } from '@supabase/supabase-js';
import type {
  ProjectData,
  Project,
  PasswordEntry,
  AppSettings,
  UIDisplaySettings,
} from '@/types';

// =====================================================
// Supabase 客戶端初始化
// =====================================================

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

// 前端使用（公開金鑰）
export const supabase = createClient(supabaseUrl, supabaseAnonKey);

// 後端使用（服務金鑰，繞過 RLS）
export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey);

// =====================================================
// 資料讀取函數
// =====================================================

/**
 * 讀取所有專案資料（管理員模式）
 */
export async function readProjectData(): Promise<ProjectData> {
  try {
    // 1. 讀取專案
    const { data: projects, error: projectsError } = await supabaseAdmin
      .from('projects')
      .select('*')
      .order('sort_order', { ascending: true });

    if (projectsError) throw projectsError;

    // 2. 讀取密碼
    const { data: passwords, error: passwordsError } = await supabaseAdmin
      .from('passwords')
      .select('*');

    if (passwordsError) throw passwordsError;

    // 3. 讀取設定
    const { data: settingsData, error: settingsError } = await supabaseAdmin
      .from('settings')
      .select('*');

    if (settingsError) throw settingsError;

    // 4. 組合設定資料
    const appSettingsRow = settingsData.find(s => s.key === 'app_settings');
    const uiDisplayRow = settingsData.find(s => s.key === 'ui_display');

    const settings: AppSettings = {
      ...(appSettingsRow?.value as any),
      uiDisplay: uiDisplayRow?.value as UIDisplaySettings,
    };

    // 5. 轉換專案資料格式（資料庫欄位名稱 → 程式碼格式）
    const formattedProjects: Project[] = projects.map(p => ({
      id: p.id,
      dateAndFileName: p.date_and_file_name,
      description: p.description,
      category: p.category as any,
      status: p.status as any,
      github: p.github,
      vercel: p.vercel,
      deployment: p.deployment,
      path: p.path,
      statusNote: p.status_note,
      publicNote: p.public_note,
      developerNote: p.developer_note,
      visibility: p.visibility as any,
      imagePreviews: p.image_previews as any,
      imagePreviewMode: p.image_preview_mode as any,
      customInfoSections: p.custom_info_sections as any,
      documentMeta: p.document_meta,
      featured: p.featured,
      hidden: p.hidden,
      sortOrder: p.sort_order,
      createdAt: new Date(p.created_at).getTime(),
      updatedAt: new Date(p.updated_at).getTime(),
    }));

    // 6. 轉換密碼資料格式
    const formattedPasswords: PasswordEntry[] = passwords.map(p => ({
      id: p.id,
      platform: p.platform,
      account: p.account,
      password: p.password,
      createdAt: new Date(p.created_at).getTime(),
      updatedAt: new Date(p.updated_at).getTime(),
    }));

    // 7. 計算元數據
    const metadata = {
      lastUpdated: Date.now(),
      version: '2.0.0',
      totalProjects: formattedProjects.length,
      publicProjects: formattedProjects.filter(
        p => !p.hidden && p.visibility.description && p.status !== 'discarded'
      ).length,
    };

    return {
      projects: formattedProjects,
      passwords: formattedPasswords,
      settings,
      metadata,
    };
  } catch (error) {
    console.error('❌ 讀取資料失敗:', error);
    throw new Error(`Supabase 讀取失敗: ${error.message}`);
  }
}

/**
 * 讀取公開專案（訪客模式）
 */
export async function getPublicProjects(): Promise<Project[]> {
  try {
    const { data: projects, error } = await supabase
      .from('projects')
      .select('*')
      .eq('hidden', false)
      .neq('status', 'discarded')
      .order('sort_order', { ascending: true });

    if (error) throw error;

    return projects.map(p => ({
      id: p.id,
      dateAndFileName: p.date_and_file_name,
      description: p.description,
      category: p.category as any,
      status: p.status as any,
      github: p.github,
      vercel: p.vercel,
      deployment: p.deployment,
      path: p.path,
      statusNote: p.status_note,
      publicNote: p.public_note,
      developerNote: '', // 訪客不可見
      visibility: p.visibility as any,
      imagePreviews: p.image_previews as any,
      imagePreviewMode: p.image_preview_mode as any,
      customInfoSections: p.custom_info_sections as any,
      documentMeta: p.document_meta,
      featured: p.featured,
      hidden: p.hidden,
      sortOrder: p.sort_order,
      createdAt: new Date(p.created_at).getTime(),
      updatedAt: new Date(p.updated_at).getTime(),
    }));
  } catch (error) {
    console.error('❌ 讀取公開專案失敗:', error);
    throw error;
  }
}

// =====================================================
// 專案操作函數
// =====================================================

/**
 * 新增專案
 */
export async function createProject(project: Partial<Project>): Promise<Project> {
  try {
    const { data, error } = await supabaseAdmin
      .from('projects')
      .insert([{
        id: project.id,
        date_and_file_name: project.dateAndFileName,
        description: project.description,
        category: project.category,
        status: project.status,
        github: project.github,
        vercel: project.vercel,
        deployment: project.deployment,
        path: project.path,
        status_note: project.statusNote,
        public_note: project.publicNote,
        developer_note: project.developerNote,
        visibility: project.visibility,
        image_previews: project.imagePreviews || [],
        image_preview_mode: project.imagePreviewMode || 'grid',
        custom_info_sections: project.customInfoSections || [],
        document_meta: project.documentMeta,
        featured: project.featured || false,
        hidden: project.hidden || false,
        sort_order: project.sortOrder || 0,
      }])
      .select()
      .single();

    if (error) throw error;

    return convertDbProjectToProject(data);
  } catch (error) {
    console.error('❌ 新增專案失敗:', error);
    throw error;
  }
}

/**
 * 更新專案
 */
export async function updateProject(
  id: string,
  updates: Partial<Project>
): Promise<Project> {
  try {
    const updateData: any = {};
    
    // 轉換欄位名稱
    if (updates.dateAndFileName !== undefined) updateData.date_and_file_name = updates.dateAndFileName;
    if (updates.description !== undefined) updateData.description = updates.description;
    if (updates.category !== undefined) updateData.category = updates.category;
    if (updates.status !== undefined) updateData.status = updates.status;
    if (updates.github !== undefined) updateData.github = updates.github;
    if (updates.vercel !== undefined) updateData.vercel = updates.vercel;
    if (updates.deployment !== undefined) updateData.deployment = updates.deployment;
    if (updates.path !== undefined) updateData.path = updates.path;
    if (updates.statusNote !== undefined) updateData.status_note = updates.statusNote;
    if (updates.publicNote !== undefined) updateData.public_note = updates.publicNote;
    if (updates.developerNote !== undefined) updateData.developer_note = updates.developerNote;
    if (updates.visibility !== undefined) updateData.visibility = updates.visibility;
    if (updates.imagePreviews !== undefined) updateData.image_previews = updates.imagePreviews;
    if (updates.imagePreviewMode !== undefined) updateData.image_preview_mode = updates.imagePreviewMode;
    if (updates.customInfoSections !== undefined) updateData.custom_info_sections = updates.customInfoSections;
    if (updates.documentMeta !== undefined) updateData.document_meta = updates.documentMeta;
    if (updates.featured !== undefined) updateData.featured = updates.featured;
    if (updates.hidden !== undefined) updateData.hidden = updates.hidden;
    if (updates.sortOrder !== undefined) updateData.sort_order = updates.sortOrder;

    const { data, error } = await supabaseAdmin
      .from('projects')
      .update(updateData)
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;

    return convertDbProjectToProject(data);
  } catch (error) {
    console.error('❌ 更新專案失敗:', error);
    throw error;
  }
}

/**
 * 刪除專案
 */
export async function deleteProject(id: string): Promise<void> {
  try {
    const { error } = await supabaseAdmin
      .from('projects')
      .delete()
      .eq('id', id);

    if (error) throw error;
  } catch (error) {
    console.error('❌ 刪除專案失敗:', error);
    throw error;
  }
}

/**
 * 批量更新專案排序
 */
export async function reorderProjects(
  updates: Array<{ id: string; sortOrder: number }>
): Promise<void> {
  try {
    // Supabase 不支援批量更新，需要逐一更新
    for (const update of updates) {
      const { error } = await supabaseAdmin
        .from('projects')
        .update({ sort_order: update.sortOrder })
        .eq('id', update.id);

      if (error) throw error;
    }
  } catch (error) {
    console.error('❌ 更新排序失敗:', error);
    throw error;
  }
}

// =====================================================
// UI 設定操作
// =====================================================

/**
 * 讀取 UI 顯示設定
 */
export async function getUIDisplaySettings(): Promise<UIDisplaySettings> {
  try {
    const { data, error } = await supabase
      .from('settings')
      .select('value')
      .eq('key', 'ui_display')
      .single();

    if (error) throw error;

    return data.value as UIDisplaySettings;
  } catch (error) {
    console.error('❌ 讀取 UI 設定失敗:', error);
    throw error;
  }
}

/**
 * 更新 UI 顯示設定
 */
export async function updateUIDisplaySettings(
  settings: UIDisplaySettings
): Promise<void> {
  try {
    const { error } = await supabaseAdmin
      .from('settings')
      .update({ value: settings })
      .eq('key', 'ui_display');

    if (error) throw error;
  } catch (error) {
    console.error('❌ 更新 UI 設定失敗:', error);
    throw error;
  }
}

// =====================================================
// 輔助函數
// =====================================================

/**
 * 轉換資料庫格式 → 程式碼格式
 */
function convertDbProjectToProject(dbProject: any): Project {
  return {
    id: dbProject.id,
    dateAndFileName: dbProject.date_and_file_name,
    description: dbProject.description,
    category: dbProject.category,
    status: dbProject.status,
    github: dbProject.github,
    vercel: dbProject.vercel,
    deployment: dbProject.deployment,
    path: dbProject.path,
    statusNote: dbProject.status_note,
    publicNote: dbProject.public_note,
    developerNote: dbProject.developer_note,
    visibility: dbProject.visibility,
    imagePreviews: dbProject.image_previews || [],
    imagePreviewMode: dbProject.image_preview_mode,
    customInfoSections: dbProject.custom_info_sections || [],
    documentMeta: dbProject.document_meta,
    featured: dbProject.featured,
    hidden: dbProject.hidden,
    sortOrder: dbProject.sort_order,
    createdAt: new Date(dbProject.created_at).getTime(),
    updatedAt: new Date(dbProject.updated_at).getTime(),
  };
}

/**
 * 驗證管理員密碼
 */
export function verifyAdminPassword(password: string): boolean {
  return password === process.env.ADMIN_PASSWORD;
}
```

---

## 🔄 步驟 3：修改 API 路由

### 3.1 修改專案列表 API

**檔案**：`app/api/projects/route.ts`

**修改策略**：
- 移除 `blob-storage.ts` 的引用
- 改用 `supabase.ts` 的函數
- 保持其他邏輯不變

**完整內容**：

```typescript
import { NextResponse } from 'next/server';
import { v4 as uuidv4 } from 'uuid';
import {
  readProjectData,
  getPublicProjects,
  createProject,
  verifyAdminPassword,
} from '@/lib/supabase';
import type { Project } from '@/types';

// GET /api/projects - 獲取專案列表
export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const isAdmin = searchParams.get('admin') === 'true';
    const password = request.headers.get('x-admin-password');

    if (isAdmin) {
      // 驗證管理員密碼
      if (!password || !verifyAdminPassword(password)) {
        return NextResponse.json(
          { error: '未授權' },
          { status: 401 }
        );
      }

      // 返回所有專案
      const data = await readProjectData();
      return NextResponse.json(data.projects);
    } else {
      // 返回公開專案
      const projects = await getPublicProjects();
      return NextResponse.json(projects);
    }
  } catch (error) {
    console.error('GET /api/projects 錯誤:', error);
    return NextResponse.json(
      { error: '讀取失敗' },
      { status: 500 }
    );
  }
}

// POST /api/projects - 新增專案
export async function POST(request: Request) {
  try {
    const password = request.headers.get('x-admin-password');

    // 驗證管理員密碼
    if (!password || !verifyAdminPassword(password)) {
      return NextResponse.json(
        { error: '未授權' },
        { status: 401 }
      );
    }

    const projectData = await request.json();

    // 產生新 ID
    const newProject: Partial<Project> = {
      ...projectData,
      id: uuidv4(),
      createdAt: Date.now(),
      updatedAt: Date.now(),
    };

    // 新增專案
    const created = await createProject(newProject);

    return NextResponse.json(created, { status: 201 });
  } catch (error) {
    console.error('POST /api/projects 錯誤:', error);
    return NextResponse.json(
      { error: '新增失敗' },
      { status: 500 }
    );
  }
}
```

### 3.2 修改單一專案 API

**檔案**：`app/api/projects/[id]/route.ts`

```typescript
import { NextResponse } from 'next/server';
import {
  readProjectData,
  updateProject,
  deleteProject,
  verifyAdminPassword,
} from '@/lib/supabase';

// GET /api/projects/:id - 獲取單一專案
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const data = await readProjectData();
    const project = data.projects.find(p => p.id === params.id);

    if (!project) {
      return NextResponse.json(
        { error: '專案不存在' },
        { status: 404 }
      );
    }

    return NextResponse.json(project);
  } catch (error) {
    console.error('GET /api/projects/:id 錯誤:', error);
    return NextResponse.json(
      { error: '讀取失敗' },
      { status: 500 }
    );
  }
}

// PATCH /api/projects/:id - 更新專案
export async function PATCH(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const password = request.headers.get('x-admin-password');

    if (!password || !verifyAdminPassword(password)) {
      return NextResponse.json(
        { error: '未授權' },
        { status: 401 }
      );
    }

    const updates = await request.json();
    const updated = await updateProject(params.id, updates);

    return NextResponse.json(updated);
  } catch (error) {
    console.error('PATCH /api/projects/:id 錯誤:', error);
    return NextResponse.json(
      { error: '更新失敗' },
      { status: 500 }
    );
  }
}

// DELETE /api/projects/:id - 刪除專案
export async function DELETE(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const password = request.headers.get('x-admin-password');

    if (!password || !verifyAdminPassword(password)) {
      return NextResponse.json(
        { error: '未授權' },
        { status: 401 }
      );
    }

    await deleteProject(params.id);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('DELETE /api/projects/:id 錯誤:', error);
    return NextResponse.json(
      { error: '刪除失敗' },
      { status: 500 }
    );
  }
}
```

### 3.3 修改專案排序 API

**檔案**：`app/api/projects/reorder/route.ts`

```typescript
import { NextResponse } from 'next/server';
import { reorderProjects, verifyAdminPassword } from '@/lib/supabase';

export async function POST(request: Request) {
  try {
    const password = request.headers.get('x-admin-password');

    if (!password || !verifyAdminPassword(password)) {
      return NextResponse.json(
        { error: '未授權' },
        { status: 401 }
      );
    }

    const updates = await request.json();
    await reorderProjects(updates);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('POST /api/projects/reorder 錯誤:', error);
    return NextResponse.json(
      { error: '更新排序失敗' },
      { status: 500 }
    );
  }
}
```

### 3.4 修改 UI 設定 API

**檔案**：`app/api/settings/ui-display/route.ts`

```typescript
import { NextResponse } from 'next/server';
import {
  getUIDisplaySettings,
  updateUIDisplaySettings,
  verifyAdminPassword,
} from '@/lib/supabase';

// GET /api/settings/ui-display
export async function GET() {
  try {
    const settings = await getUIDisplaySettings();
    return NextResponse.json(settings);
  } catch (error) {
    console.error('GET /api/settings/ui-display 錯誤:', error);
    return NextResponse.json(
      { error: '讀取失敗' },
      { status: 500 }
    );
  }
}

// PUT /api/settings/ui-display
export async function PUT(request: Request) {
  try {
    const password = request.headers.get('x-admin-password');

    if (!password || !verifyAdminPassword(password)) {
      return NextResponse.json(
        { error: '未授權' },
        { status: 401 }
      );
    }

    const settings = await request.json();
    await updateUIDisplaySettings(settings);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('PUT /api/settings/ui-display 錯誤:', error);
    return NextResponse.json(
      { error: '更新失敗' },
      { status: 500 }
    );
  }
}
```

---

## 🗂️ 步驟 4：移除舊的資料存取層（選擇性）

### 4.1 保留備份

```bash
# 重新命名舊檔案作為備份
mv app/lib/blob-storage.ts app/lib/blob-storage.ts.backup
mv app/lib/data-safety.ts app/lib/data-safety.ts.backup
```

### 4.2 或暫時保留

如果想要雙重保險，可以暫時保留舊檔案，等確認新系統穩定後再刪除。

---

## 🔑 步驟 5：設定本地環境變數

### 5.1 建立 .env.local

**在專案根目錄建立或修改** `.env.local`：

```bash
# Supabase 設定
NEXT_PUBLIC_SUPABASE_URL=https://[your-project-id].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# 管理員密碼（保持不變）
ADMIN_PASSWORD=你的管理員密碼
```

**重要提醒**：
- ⚠️ `.env.local` 不應提交到 Git
- ⚠️ Service Role Key 必須保密
- ✅ 從 Supabase Settings → API 複製金鑰

---

## 🧪 步驟 6：本地測試

### 6.1 啟動開發伺服器

```bash
npm run dev

# 應該看到：
# ▲ Next.js 14.x.x
# - Local:        http://localhost:3000
# - ready started server on 0.0.0.0:3000
```

### 6.2 測試訪客功能

**在瀏覽器前往**：`http://localhost:3000`

```
測試項目：
□ 首頁載入正常
□ 可看到專案列表
□ 專案數量正確
□ 搜尋功能正常
□ 篩選功能正常
□ 圖片顯示正常（檢查是否從 Supabase Storage 載入）
□ 統計數據正確
```

**檢查圖片 URL**：
- 右鍵檢查圖片
- URL 應該是 `https://xxx.supabase.co/storage/v1/object/public/screenshots/...`

### 6.3 測試管理員功能

**前往管理後台**：`http://localhost:3000/admin`

```
測試項目：
□ 可正常登入
□ 後台載入正常
□ 可看到所有專案（包括隱藏的）
□ 新增專案成功
□ 編輯專案成功
□ 刪除專案成功
□ 排序功能正常
□ 儲存後立即看到變更（< 1 秒）⭐ 重點測試
```

### 6.4 檢查開發者工具

**按 F12 開啟開發者工具**：

```
Console 標籤：
□ 無紅色錯誤訊息
□ 可能有一些 Info 或 Warning（正常）

Network 標籤：
□ API 請求都返回 200 或 201
□ 沒有 401 或 500 錯誤
□ 回應時間 < 500ms（Supabase 速度）
```

### 6.5 效能測試

**重點測試即時性**：

```
1. 在後台新增一個測試專案
2. 點擊儲存
3. 計時看多久可以看到變更

預期結果：
✅ < 1 秒即可看到變更（大幅改善！）
✅ 無需重新整理頁面
✅ 資料立即同步
```

---

## ✅ 完成檢核

### 程式碼修改
- [ ] ✅ 已安裝 @supabase/supabase-js
- [ ] ✅ 已建立 app/lib/supabase.ts
- [ ] ✅ 已修改 app/api/projects/route.ts
- [ ] ✅ 已修改 app/api/projects/[id]/route.ts
- [ ] ✅ 已修改 app/api/projects/reorder/route.ts
- [ ] ✅ 已修改 app/api/settings/ui-display/route.ts
- [ ] ✅ 已設定 .env.local

### 本地測試
- [ ] ✅ 開發伺服器正常啟動
- [ ] ✅ 訪客功能全部正常
- [ ] ✅ 管理員功能全部正常
- [ ] ✅ 即時更新正常（< 1 秒）
- [ ] ✅ 無 Console 錯誤
- [ ] ✅ API 回應時間正常

### 資料驗證
- [ ] ✅ 專案列表資料正確
- [ ] ✅ 圖片從 Supabase 載入
- [ ] ✅ 新增/編輯/刪除都正常
- [ ] ✅ 排序功能正常

---

## 🎯 下一步

恭喜完成程式碼改造！您現在已經：
- ✅ 成功將程式碼連接到 Supabase
- ✅ 在本地測試所有功能正常
- ✅ 驗證了即時更新能力

**程式碼已經準備好部署到線上了！**

👉 請返回閱讀：`00_遷移總覽與流程清單.md` 的階段 4

---

## 🆘 遇到問題？

### 常見問題

**Q: 環境變數讀取不到？**  
A: 修改 .env.local 後需要重啟開發伺服器（Ctrl+C 然後 npm run dev）

**Q: 圖片無法顯示？**  
A: 檢查 Storage bucket 的 Public 權限和 CORS 設定

**Q: API 返回 401 錯誤？**  
A: 檢查 SUPABASE_SERVICE_ROLE_KEY 是否正確設定

**Q: TypeScript 類型錯誤？**  
A: 確認 @/types 中的類型定義與資料庫結構一致

**Q: 資料格式不符？**  
A: 檢查 convertDbProjectToProject 函數的欄位映射


