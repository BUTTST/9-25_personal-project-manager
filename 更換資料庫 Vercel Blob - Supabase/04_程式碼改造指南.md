# 階段 3：程式碼改造指南

> ⏱️ 實際時間：**30-40 分鐘**  
> 🎯 目標：將程式碼從 Vercel Blob 改為 Supabase  
> 📝 難度：⭐⭐⭐  
> ⭐ 輔助：Cursor AI 可協助生成大部分代碼

---

## 📋 本階段目標

完成後，您將達成：
- ✅ 安裝 Supabase 依賴
- ✅ 建立 Supabase client 配置
- ✅ 建立 Storage 操作庫
- ✅ 改造所有 API routes
- ✅ 建立圖片管理系統
- ✅ 清理 Vercel Blob 代碼
- ✅ 本地測試通過

---

## 🔧 步驟 1：安裝依賴

### 1.1 新增 Supabase 套件

```bash
npm install @supabase/supabase-js
```

### 1.2 更新 package.json

```json
{
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0",
    // ... 其他依賴
  }
}
```

### 1.3 移除 Vercel Blob（遷移完成後）

```bash
npm uninstall @vercel/blob
```

**節省**：77 個相依套件

---

## 📝 步驟 2：建立 Supabase 配置

### 2.1 建立 app/lib/supabase.ts

**完整程式碼**：請參考 `資料庫架構變更紀錄.md`

**核心內容**：

```typescript
import { createClient } from '@supabase/supabase-js';

// 環境變數
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

// 前端 Client（受 RLS 限制）
export const supabase = createClient(supabaseUrl, supabaseAnonKey);

// 後端 Admin Client（繞過 RLS）
export const supabaseAdmin = supabaseServiceKey
  ? createClient(supabaseUrl, supabaseServiceKey, {
      auth: { autoRefreshToken: false, persistSession: false }
    })
  : null;

// Storage URL 輔助函式
export function getStoragePublicUrl(path: string): string {
  return `${supabaseUrl}/storage/v1/object/public/project-images/${path}`;
}
```

**重點**：
- ⚠️ bucket 名稱使用 `project-images`（不是 `screenshots`）
- ⚠️ 環境變數處理要支援開發/構建/生產環境
- ⚠️ 型別定義要完整

---

## 📝 步驟 3：建立 Storage 操作庫

### 3.1 建立 app/lib/storage.ts

**功能清單**：

```typescript
// 8 個核心函式
export async function uploadImage(file: File, filename?: string)
export async function uploadMultipleImages(files: File[])
export async function listImages()
export async function deleteImage(filename: string)
export async function deleteMultipleImages(filenames: string[])
export async function renameImage(oldFilename: string, newFilename: string)
export async function checkImageReferences(filename: string)
export async function updateImageReferences(oldFilename, newFilename, projectIds)
```

**重點**：
- ⚠️ bucket 名稱：`project-images`
- ⚠️ 中文檔名處理：移除中文字符，使用雙檔名系統
- ⚠️ 引用追蹤：自動更新專案的 image_previews

---

## 📝 步驟 4：改造 API Routes

### 4.1 需要修改的檔案

```yaml
主要 API（7 個）:
  ✅ app/api/projects/route.ts - 列表/新增
  ✅ app/api/projects/[id]/route.ts - 單一專案操作
  ✅ app/api/projects/reorder/route.ts - 排序
  ✅ app/api/settings/ui-display/route.ts - UI 設定
  ✅ app/api/settings/reset-ui/route.ts - 重置設定
  ✅ app/api/admin/diagnose/route.ts - 診斷
  ✅ app/api/admin/import-data/route.ts - 批量匯入

新增 API（4 個）:
  ✅ app/api/images/route.ts - 列出/上傳圖片
  ✅ app/api/images/rename/route.ts - 重命名圖片
  ✅ app/api/images/delete/route.ts - 刪除圖片
  ✅ app/api/images/check-references/route.ts - 檢查引用
```

### 4.2 核心變更模式

**從 Blob 到 Supabase**：

```typescript
// 修改前（Blob）
import { readProjectData, writeProjectData } from '@/lib/blob-storage';
const data = await readProjectData();
await writeProjectData(updatedData);

// 修改後（Supabase）
import { supabaseAdmin } from '@/lib/supabase';
    const { data, error } = await supabaseAdmin
      .from('projects')
  .select('*');
await supabaseAdmin
  .from('projects')
  .update(updates)
  .eq('id', id);
```

### 4.3 欄位名稱轉換

**重要**：資料庫使用 snake_case，API 使用 camelCase

```typescript
// DB → Frontend
dateAndFileName: dbRow.date_and_file_name
statusNote: dbRow.status_note
imagePreviews: dbRow.image_previews

// Frontend → DB
date_and_file_name: formData.dateAndFileName
status_note: formData.statusNote
image_previews: formData.imagePreviews
```

---

## 📝 步驟 5：建立圖片管理功能

### 5.1 新增元件

```yaml
元件檔案:
  ✅ app/components/admin/ImageUploader.tsx - 拖拽上傳
  ✅ app/components/admin/ImageGallery.tsx - 圖片庫管理
```

### 5.2 新增頁面

```yaml
頁面檔案:
  ✅ app/admin/images/page.tsx - 圖片管理頁面
```

### 5.3 更新管理後台

```yaml
修改檔案:
  ✅ app/admin/page.tsx - 新增「圖片管理」tab
  
Tab 順序:
  1. 專案管理
  2. 批量導入
  3. 圖片管理 ⭐ 新增
  4. 系統設定
  5. 系統診斷
```

---

## 🧹 步驟 6：清理 Vercel Blob 代碼

### 6.1 刪除/歸檔檔案

```bash
# 刪除舊版代碼
rm app/lib/blob-storage.ts
rm app/lib/data-safety.ts
```

### 6.2 標記廢棄 API

```yaml
廢棄端點（返回 410 Gone）:
  ✅ /api/initialize - 自動初始化
  ✅ /api/admin/init-data - 資料初始化
  ✅ /api/admin/force-init - 強制初始化
```

### 6.3 更新前端頁面

```typescript
// app/page.tsx
// 移除 blob-storage 引用
// 使用本地 defaultUIDisplaySettings
```

---

## 🔧 步驟 7：設定環境變數

### 7.1 建立 .env.local

```bash
# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=https://cfsseikonkwfwkhsiavm.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# 管理員密碼
ADMIN_PASSWORD=your-secure-admin-password
```

### 7.2 設定 Vercel 環境變數

```
1. Vercel Dashboard → Settings → Environment Variables
2. 新增 3 個 Supabase 變數
3. 確保 ADMIN_PASSWORD 保持不變
4. 所有環境都要設定（Production, Preview, Development）
```

---

## 🧪 步驟 8：本地測試

### 8.1 啟動開發環境

```bash
npm install          # 安裝新依賴
npm run dev          # 啟動開發伺服器
```

### 8.2 測試清單

**前端（訪客）**：
- [ ] 首頁顯示 16 個專案
- [ ] 篩選器正常運作
- [ ] 搜尋功能正常
- [ ] 圖片顯示正常（public 路徑）

**後台（管理員）**：
- [ ] 可以登入
- [ ] 專案列表顯示 16 個
- [ ] 可以新增專案
- [ ] 可以編輯專案
- [ ] 可以刪除專案
- [ ] 圖片管理頁面正常
- [ ] 可以上傳圖片
- [ ] 可以編輯檔名
- [ ] 引用檢查正常

### 8.3 檢查 Console

開啟瀏覽器開發者工具（F12）：
- [ ] 無紅色錯誤訊息
- [ ] API 請求成功（200/201 狀態碼）
- [ ] Supabase 查詢成功

---

## 🚀 步驟 9：部署到 Vercel

### 9.1 常見部署錯誤與修復

#### 錯誤 1：模組導入路徑

**問題**：`Module not found: '@/app/lib/supabase'`

**修復**：
```bash
# 全域搜尋並替換
grep -r "@/app/lib" app/
# 替換為 @/lib
```

#### 錯誤 2：環境變數缺失

**問題**：構建時 Supabase 初始化失敗

**修復**：更新 `app/lib/supabase.ts` 允許構建時使用佔位符

#### 錯誤 3：TypeScript 編譯歸檔檔案

**問題**：編譯器處理歸檔資料夾的檔案

**修復**：更新 `tsconfig.json`：
```json
{
  "exclude": ["node_modules", "更換資料庫 Vercel Blob - Supabase/**"]
}
```

### 9.2 Git 推送

```bash
# 檢查變更
git status
git diff

# 暫存所有變更
git add .

# 提交（完整訊息見文末）
git commit -m "feat: 遷移到 Supabase v2.0 並新增圖片管理系統"

# 推送到 GitHub
git push origin main
```

### 9.3 Vercel 自動部署

```
1. 推送後 Vercel 自動觸發部署
2. 等待構建完成（3-5 分鐘）
3. 檢查構建日誌（Build Logs）
4. 確認無錯誤訊息
```

### 9.4 線上驗證

**訪問線上網站**：
- [ ] 首頁載入正常
- [ ] 專案資料顯示正確
- [ ] 管理後台可登入
- [ ] 圖片管理功能正常
- [ ] 所有 CRUD 操作成功

---

## 📊 完整變更統計

### 新增檔案（10 個）

```yaml
核心配置:
  ✅ app/lib/supabase.ts - Supabase client
  ✅ app/lib/storage.ts - Storage 操作庫

圖片管理 API:
  ✅ app/api/images/route.ts
  ✅ app/api/images/rename/route.ts
  ✅ app/api/images/delete/route.ts
  ✅ app/api/images/check-references/route.ts

圖片管理 UI:
  ✅ app/components/admin/ImageUploader.tsx
  ✅ app/components/admin/ImageGallery.tsx
  ✅ app/admin/images/page.tsx

文檔:
  ✅ 資料庫架構變更紀錄.md
```

### 修改檔案（11 個）

```yaml
API Routes:
  ✅ app/api/projects/route.ts
  ✅ app/api/projects/[id]/route.ts
  ✅ app/api/projects/reorder/route.ts
  ✅ app/api/settings/ui-display/route.ts
  ✅ app/api/settings/reset-ui/route.ts
  ✅ app/api/admin/diagnose/route.ts
  ✅ app/api/admin/import-data/route.ts

前端頁面:
  ✅ app/admin/page.tsx - 新增圖片管理 tab
  ✅ app/page.tsx - 移除 blob-storage 引用

配置:
  ✅ package.json - 更新依賴
  ✅ tsconfig.json - 排除歸檔資料夾
```

### 刪除檔案（2 個）

```yaml
已移除:
  ✅ app/lib/blob-storage.ts - Vercel Blob 操作（已歸檔）
  ✅ app/lib/data-safety.ts - 資料安全驗證（已歸檔）
```

### 廢棄 API（3 個）

```yaml
返回 410 Gone:
  ✅ /api/initialize
  ✅ /api/admin/init-data
  ✅ /api/admin/force-init
```

---

## ⚠️ 常見錯誤與修復

> 💡 **完整錯誤列表**：請參閱 `改建Supabase遇到的各種錯誤與解決方法.md`

### 快速參考

| 錯誤 | 症狀 | 修復 |
|------|------|------|
| **路徑錯誤** | `Module not found` | 使用 `@/lib` 而非 `@/app/lib` |
| **環境變數** | `Missing Supabase...` | 更新 supabase.ts 邏輯 |
| **Bucket 名稱** | `Bucket not found` | 使用 `project-images` |
| **中文檔名** | `Invalid key` | 實施雙檔名系統 |

---

## ✅ 完成檢核

### 程式碼檢查

- [ ] ✅ 所有 import 路徑正確（`@/lib` 不是 `@/app/lib`）
- [ ] ✅ bucket 名稱統一為 `project-images`
- [ ] ✅ 環境變數處理邏輯完整
- [ ] ✅ 欄位名稱轉換正確（snake_case ↔ camelCase）
- [ ] ✅ 錯誤處理完善

### 功能檢查

- [ ] ✅ 本地測試通過
- [ ] ✅ 構建成功（`npm run build`）
- [ ] ✅ 線上部署成功
- [ ] ✅ 所有功能正常運作

### 清理檢查

- [ ] ✅ Vercel Blob 代碼已移除
- [ ] ✅ 舊 API 已標記廢棄
- [ ] ✅ package.json 已更新
- [ ] ✅ 文檔已更新

---

## 📝 Git 提交訊息範本

### 主要遷移

```bash
feat: 遷移到 Supabase 並新增圖片管理系統 (v2.0)

🔄 核心架構變更:
- 資料庫: Vercel Blob → Supabase PostgreSQL
- Storage: public 靜態資源 → Supabase Storage
- 查詢效能提升 90%+, RLS 安全規則

⭐ 新增功能:
- 圖片管理系統（拖拽上傳、重命名、刪除）
- 引用追蹤與自動更新（防斷鏈）
- 管理後台新增「圖片管理」頁籤

📊 資料遷移:
- 16個專案 100% 遷移
- 2個密碼 100% 遷移
- UI 設定完整保留

🔧 技術改進:
- 新增 Supabase client 配置
- 新增 Storage 操作庫
- 重構所有 API routes
- 新增圖片管理 API（4個端點）

🆕 新增檔案:
- app/lib/supabase.ts
- app/lib/storage.ts
- app/api/images/* (4個端點)
- app/components/admin/ImageUploader.tsx
- app/components/admin/ImageGallery.tsx
- app/admin/images/page.tsx

📚 文檔:
- 新增資料庫架構變更紀錄.md
- 更新 README.md (v2.0)
- 更新 .cursor/rules/

Breaking Changes:
- 需安裝 @supabase/supabase-js
- 需設定 3個 Supabase 環境變數
- API 內部實作完全重寫（外部介面保持相容）
```

### 錯誤修復

```bash
fix: 修正部署構建錯誤 - 更新模組導入路徑與環境變數處理

- 修正所有 API 路由中的模組導入路徑 (@/app/lib -> @/lib)
- 修正管理後台圖片頁面的組件導入路徑
- 改善 Supabase 客戶端初始化邏輯，允許構建時缺少環境變數
- 更新 tsconfig.json 排除歸檔資料夾
- 確保生產環境構建成功通過
```

### 清理代碼

```bash
refactor: 完成 Vercel Blob 到 Supabase 的遷移清理

主要變更：
- 移除 Vercel Blob 相關代碼和依賴
  - 刪除 app/lib/blob-storage.ts（已歸檔至遷移文檔資料夾）
  - 移除 @vercel/blob 依賴包（節省 77 個包）
  
- 廢棄舊 API 端點（返回 410 Gone）
  - /api/initialize（自動初始化端點）
  - /api/admin/init-data（Blob 資料初始化）
  - /api/admin/force-init（Blob 強制初始化）
  
- 更新前端頁面
  - app/page.tsx：移除 blob-storage 引用，使用本地預設設定
  
統計：14 個檔案變更，+94/-1869 行
遷移狀態：✅ Supabase 已完全接管資料存儲
```

---

## 🎯 下一步

完成程式碼改造後：

```
1. ✅ 執行 npm run build（確認無錯誤）
2. ✅ 本地測試所有功能
3. ✅ Git 提交並推送
4. ✅ 等待 Vercel 部署
5. ✅ 線上功能驗證
6. ✅ 48 小時穩定運行後刪除 Vercel Blob
```

---

**恭喜完成程式碼改造！** 🎉

所有代碼已準備好部署到生產環境。
