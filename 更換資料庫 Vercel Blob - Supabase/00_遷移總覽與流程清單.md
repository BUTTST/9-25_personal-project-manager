# Vercel Blob → Supabase 遷移總覽

> 📅 文檔日期：2025-10-28  
> ⏱️ 預估總時間：2-4 小時  
> 🎯 目標：從 Vercel Blob 無痛遷移至 Supabase

---

## 📋 快速檢查清單

在開始前，請確認：
- [ ] 已閱讀完整的決策報告
- [ ] 理解為何選擇 Supabase
- [ ] 預留足夠時間（建議週末進行）
- [ ] 網路連線穩定

---

## 🗺️ 遷移流程總覽

```
階段 0：前置準備（15 分鐘）
  └─ 備份當前資料

階段 1：創建 Supabase 專案（30-45 分鐘）⭐ 詳見：01_創建Supabase專案.md
  └─ 在 Vercel 平台連接 Supabase
  └─ 設計資料表結構
  └─ 創建 Storage bucket
  └─ 設定安全規則

階段 2：資料遷移（1-1.5 小時）⭐ 詳見：02_資料遷移操作.md
  └─ 匯出現有 JSON 資料
  └─ 轉換並匯入 PostgreSQL
  └─ 上傳圖片到 Storage
  └─ 驗證資料完整性

階段 3：程式碼改造（1.5-2 小時）⭐ 詳見：03_程式碼改造指南.md
  └─ 安裝依賴套件
  └─ 修改資料存取層
  └─ 調整 API 路由
  └─ 本地測試

階段 4：部署與驗證（30 分鐘）
  └─ 推送到 GitHub
  └─ Vercel 自動部署
  └─ 線上功能測試
  └─ 效能驗證
```

---

## 🎯 階段 0：前置準備（15 分鐘）

### 資料備份

**目的**：確保可以隨時回退

**操作**：
```bash
# 1. 下載當前 Blob 資料
前往 Vercel 專案 → Storage → Blob → 找到 project-data.json → 下載

# 2. 儲存到本地備份資料夾
將檔案複製到：本地備份/2025-10-28_遷移前備份.json

# 3. 驗證備份
確認檔案大小正常，可用文字編輯器開啟
```

**確認事項**：
- [ ] ✅ JSON 檔案已下載
- [ ] ✅ 檔案可正常開啟
- [ ] ✅ 資料內容正確

---

## 📊 各階段詳細說明

### 階段 1：創建 Supabase 專案
**文檔**：`01_創建Supabase專案.md`  
**時間**：30-45 分鐘  
**難度**：⭐⭐⭐  
**內容**：
- 在 Vercel 平台添加 Supabase Integration
- 創建專案並獲取 API 金鑰
- 設計 3 個資料表（projects, passwords, settings）
- 創建圖片儲存 bucket
- 設定 Row Level Security 規則

### 階段 2：資料遷移
**文檔**：`02_資料遷移操作.md`  
**時間**：1-1.5 小時  
**難度**：⭐⭐  
**內容**：
- JSON 轉換為 SQL INSERT 語句
- 使用 Supabase 控制台匯入資料
- 批量上傳 30 張圖片
- 更新圖片路徑引用

### 階段 3：程式碼改造
**文檔**：`03_程式碼改造指南.md`  
**時間**：1.5-2 小時  
**難度**：⭐⭐⭐⭐  
**內容**：
- 建立 `app/lib/supabase.ts`
- 修改 7 個 API 路由檔案
- 更新環境變數
- 本地測試所有功能

### 階段 4：部署與驗證
**文檔**：直接在此文檔  
**時間**：30 分鐘  
**難度**：⭐  
**內容**：簡單的推送和測試

---

## 🚀 階段 4：部署與驗證（詳細步驟）

### 4.1 推送程式碼

```bash
# 1. 確認所有變更已儲存
git status

# 2. 加入變更
git add .

# 3. 提交變更
git commit -m "feat: 遷移至 Supabase 資料庫"

# 4. 推送到 GitHub
git push origin main
```

### 4.2 Vercel 自動部署

**操作**：
1. 前往 Vercel 控制台
2. 觀察 Deployments 頁面
3. 等待建置完成（約 2-5 分鐘）
4. 查看建置日誌（Build Logs）確認無錯誤

**英文對照**：
- Deployments = 部署紀錄
- Build Logs = 建置日誌
- Production = 正式環境

### 4.3 功能測試清單

#### 訪客功能
- [ ] 首頁載入正常
- [ ] 可看到專案列表
- [ ] 搜尋功能正常
- [ ] 篩選功能正常
- [ ] 圖片顯示正常
- [ ] 統計數據正確

#### 管理員功能
- [ ] 可正常登入
- [ ] 後台載入正常
- [ ] 新增專案成功
- [ ] 編輯專案成功
- [ ] 刪除專案成功
- [ ] 圖片上傳成功
- [ ] 儲存後立即看到變更（< 1 秒）

#### 效能測試
- [ ] 頁面載入時間 < 2 秒
- [ ] API 回應時間 < 500ms
- [ ] 圖片載入速度快

### 4.4 驗證備份功能

**在 Supabase 控制台**：

1. 前往 `Database` → `Backups`
2. 確認自動備份已啟用
3. 查看備份頻率（應為每日）

**英文對照**：
- Database = 資料庫
- Backups = 備份
- Daily Backups = 每日備份
- Point-in-Time Recovery = 時間點恢復（PITR）

### 4.5 測試回檔功能（選擇性）

**操作**：
1. 在後台新增一個測試專案
2. 記錄時間戳
3. 在 Supabase 控制台嘗試回檔到此時間點之前

---

## ⚠️ 常見問題與解決方案

### 問題 1：Vercel 建置失敗

**症狀**：Deployment 顯示 Failed  
**原因**：環境變數未設定或程式碼錯誤  
**解決**：
1. 檢查 Vercel 環境變數是否正確設定
2. 查看 Build Logs 找出具體錯誤
3. 確認 `@supabase/supabase-js` 已正確安裝

### 問題 2：無法連接 Supabase

**症狀**：前端顯示資料載入失敗  
**原因**：API 金鑰錯誤或 RLS 規則過嚴  
**解決**：
1. 確認環境變數中的 `SUPABASE_URL` 和 `SUPABASE_ANON_KEY` 正確
2. 檢查 Supabase RLS 規則是否允許讀取
3. 在瀏覽器 Console 查看具體錯誤訊息

### 問題 3：圖片無法顯示

**症狀**：圖片顯示為空白或 404  
**原因**：Storage bucket 權限設定或圖片路徑錯誤  
**解決**：
1. 確認 Storage bucket 的 Public 權限已開啟
2. 檢查圖片 URL 格式是否正確
3. 在 Supabase Storage 直接訪問圖片 URL 測試

---

## 🔄 回退計畫

如果遷移過程中遇到無法解決的問題：

### 立即回退步驟

```bash
# 1. 切換到遷移前的 Git commit
git log  # 找到遷移前的 commit ID
git checkout <commit-id>

# 2. 強制推送（⚠️ 謹慎使用）
git push origin main --force

# 3. Vercel 會自動回退到舊版本
# 等待部署完成即可恢復服務
```

### 資料回復

1. 如果已經刪除 Vercel Blob 資料：
   - 使用備份的 JSON 檔案
   - 透過管理後台重新匯入

2. 如果保留了 Vercel Blob：
   - 直接切回程式碼即可
   - 資料完全不受影響

---

## ✅ 遷移完成檢核

當所有階段完成後，確認以下事項：

### 功能檢核
- [ ] ✅ 所有訪客功能正常
- [ ] ✅ 所有管理員功能正常
- [ ] ✅ 資料完整無遺失
- [ ] ✅ 圖片全部正常顯示
- [ ] ✅ 效能符合預期

### 系統檢核
- [ ] ✅ 自動備份已啟用
- [ ] ✅ 可成功回檔
- [ ] ✅ 即時更新正常（< 1 秒）
- [ ] ✅ Vercel 環境變數已設定
- [ ] ✅ 舊的 Blob 資料已備份

### 文檔檢核
- [ ] ✅ 已更新 README（如需要）
- [ ] ✅ 已記錄 Supabase 專案資訊
- [ ] ✅ 已儲存 API 金鑰（安全位置）

---

## 📌 重要提醒

### 環境變數管理
```bash
# Vercel 需要設定的環境變數：
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJxxx...
ADMIN_PASSWORD=你的管理員密碼（保持不變）
```

### 不需要刪除的內容
⚠️ **保留以下內容作為備份**：
- Vercel Blob 資料（保留至少 1 個月）
- 本地備份的 JSON 檔案
- GitHub 硬編碼的圖片（可選擇性保留）

### 費用提醒
✅ **Supabase 免費版額度**：
- 500MB 資料庫（您只需 < 10MB）
- 1GB 檔案儲存（您的圖片 < 10MB）
- 完全免費，無需擔心

---

## 🎓 學習資源

### 官方文檔
- [Supabase 官方文檔](https://supabase.com/docs)
- [Vercel x Supabase 整合指南](https://vercel.com/integrations/supabase)
- [Supabase JavaScript 客戶端](https://supabase.com/docs/reference/javascript/introduction)

### 推薦閱讀順序
1. 先閱讀本文檔（總覽）
2. 按順序執行各階段（01 → 02 → 03）
3. 遇到問題時查閱官方文檔
4. 完成後進行功能測試

---

## 📞 需要協助？

### 除錯步驟
1. 查看瀏覽器 Console（F12 開發者工具）
2. 查看 Vercel 建置日誌
3. 查看 Supabase 日誌（Logs & Reports）
4. 參考本文檔的「常見問題」章節

### AI 協助
可以向 AI 詢問：
- "如何在 Supabase 設定 RLS 規則？"
- "為什麼我的圖片無法顯示？"
- "如何除錯 Supabase 連線問題？"

---

**準備好了嗎？讓我們開始第一階段！**

👉 請繼續閱讀：`01_創建Supabase專案.md`


