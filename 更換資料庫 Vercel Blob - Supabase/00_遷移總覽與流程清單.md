# Vercel Blob → Supabase 遷移總覽

> 📅 文檔日期：2025-10-28（已更新）  
> ⏱️ 實際總時間：**2 小時**（使用 MCP 自動化）  
> 🎯 目標：從 Vercel Blob 無痛遷移至 Supabase  
> ⭐ 特色：使用 **Cursor Supabase MCP** 自動化 90% 操作

---

## 📋 快速檢查清單

在開始前，請確認：
- [ ] 已閱讀完整的決策報告
- [ ] 理解為何選擇 Supabase
- [ ] 已安裝並連接 Cursor Supabase MCP（強烈推薦）
- [ ] 網路連線穩定

---

## 🗺️ 遷移流程總覽（MCP 自動化版）

```
階段 0：前置準備（5 分鐘）
  └─ 備份當前資料

階段 1：創建 Supabase 專案（15-20 分鐘）⭐ 詳見：01_創建Supabase專案.md
  ├─ 在 Vercel 連接 Supabase（5 分鐘）
  ├─ 連接 Cursor Supabase MCP（3 分鐘）⭐ 推薦
  ├─ 建立資料表（MCP 自動，2 分鐘）⭐ 自動化
  └─ 創建 Storage bucket（手動，1 分鐘）

階段 2：資料遷移（5 分鐘）⭐ 詳見：03_資料遷移操作.md
  ├─ 使用 MCP 自動插入資料（3 分鐘）⭐ 自動化
  └─ 驗證資料完整性（2 分鐘）

階段 3：程式碼改造（30 分鐘）⭐ 詳見：04_程式碼改造指南.md
  ├─ 安裝依賴套件（1 分鐘）
  ├─ 建立 Supabase 配置（MCP 可協助）
  ├─ 改造 API 路由（MCP 可協助）
  └─ 本地測試（20 分鐘）

階段 4：部署與驗證（20 分鐘）
  ├─ 修復部署錯誤（10 分鐘）
  ├─ 推送到 GitHub
  ├─ Vercel 自動部署
  └─ 線上功能測試
```

### ⏱️ 時間對比

| 方式 | 總時間 | 說明 |
|------|--------|------|
| **傳統手動** | 3-4 小時 | 手動建表、手動插入、手動設定 |
| **使用 MCP** | 1-1.5 小時 | 自動建表、自動插入、AI 協助 |
| **節省時間** | 2-2.5 小時 | **效率提升 60%+** |

---

## 🎯 階段 0：前置準備（15 分鐘）

### 資料備份

**目的**：確保可以隨時回退

**操作**：
```bash
# 1. 下載當前 Blob 資料
前往 Vercel 專案 → Storage → Blob → 找到 project-data.json → 下載

# 2. 儲存到本地備份資料夾
將檔案複製到：本地備份/2025-10-28_遷移前備份.json

# 3. 驗證備份
確認檔案大小正常，可用文字編輯器開啟
```

**確認事項**：
- [ ] ✅ JSON 檔案已下載
- [ ] ✅ 檔案可正常開啟
- [ ] ✅ 資料內容正確

---

## 📊 各階段詳細說明

### 階段 1：創建 Supabase 專案
**文檔**：`01_創建Supabase專案.md` + `02_手動建立Storage.md`  
**時間**：15-20 分鐘（使用 MCP）  
**難度**：⭐⭐  
**內容**：
- 在 Vercel 連接 Supabase Integration（5 分鐘）
- 連接 Cursor Supabase MCP（3 分鐘）⭐ 推薦
- 使用 MCP 自動建立 3 個資料表（2 分鐘）⭐ 自動化
- 手動創建 Storage bucket（1 分鐘）
- MCP 自動設定 RLS 和 Storage 政策（1 分鐘）⭐ 自動化

### 階段 2：資料遷移
**文檔**：`03_資料遷移操作.md`（已更新為 MCP 版本）  
**時間**：5 分鐘（使用 MCP）  
**難度**：⭐  
**內容**：
- 使用 MCP 自動插入 16 個專案（2 分鐘）⭐ 自動化
- 使用 MCP 自動插入密碼和設定（1 分鐘）⭐ 自動化
- 驗證資料完整性（2 分鐘）

### 階段 3：程式碼改造
**文檔**：`04_程式碼改造指南.md`  
**時間**：30-40 分鐘  
**難度**：⭐⭐⭐  
**內容**：
- 安裝 @supabase/supabase-js（1 分鐘）
- 建立 Supabase 配置和 Storage 操作庫（5 分鐘）
- 改造 API routes 使用 Supabase（10 分鐘）
- 建立圖片管理功能（10 分鐘）
- 本地測試（15 分鐘）

### 階段 4：部署與驗證
**文檔**：直接在此文檔  
**時間**：30 分鐘  
**難度**：⭐  
**內容**：簡單的推送和測試

---

## 🚀 階段 4：部署與驗證（詳細步驟）

### 4.1 推送程式碼

```bash
# 1. 確認所有變更已儲存
git status

# 2. 加入變更
git add .

# 3. 提交變更
git commit -m "feat: 遷移至 Supabase 資料庫"

# 4. 推送到 GitHub
git push origin main
```

### 4.2 Vercel 自動部署

**操作**：
1. 前往 Vercel 控制台
2. 觀察 Deployments 頁面
3. 等待建置完成（約 2-5 分鐘）
4. 查看建置日誌（Build Logs）確認無錯誤

**英文對照**：
- Deployments = 部署紀錄
- Build Logs = 建置日誌
- Production = 正式環境

### 4.3 功能測試清單

#### 訪客功能
- [ ] 首頁載入正常
- [ ] 可看到專案列表
- [ ] 搜尋功能正常
- [ ] 篩選功能正常
- [ ] 圖片顯示正常
- [ ] 統計數據正確

#### 管理員功能
- [ ] 可正常登入
- [ ] 後台載入正常
- [ ] 新增專案成功
- [ ] 編輯專案成功
- [ ] 刪除專案成功
- [ ] 圖片上傳成功
- [ ] 儲存後立即看到變更（< 1 秒）

#### 效能測試
- [ ] 頁面載入時間 < 2 秒
- [ ] API 回應時間 < 500ms
- [ ] 圖片載入速度快

### 4.4 驗證備份功能

**在 Supabase 控制台**：

1. 前往 `Database` → `Backups`
2. 確認自動備份已啟用
3. 查看備份頻率（應為每日）

**英文對照**：
- Database = 資料庫
- Backups = 備份
- Daily Backups = 每日備份
- Point-in-Time Recovery = 時間點恢復（PITR）

### 4.5 測試回檔功能（選擇性）

**操作**：
1. 在後台新增一個測試專案
2. 記錄時間戳
3. 在 Supabase 控制台嘗試回檔到此時間點之前

---

## ⚠️ 常見問題與解決方案

> 💡 **詳細錯誤排查**：請參閱 `改建Supabase遇到的各種錯誤與解決方法.md`

### 問題 1：模組導入路徑錯誤

**症狀**：`Module not found: Can't resolve '@/app/lib/supabase'`  
**原因**：使用錯誤的路徑別名  
**解決**：使用 `@/lib/supabase` 而非 `@/app/lib/supabase`

### 問題 2：環境變數處理錯誤

**症狀**：`Error: Missing Supabase environment variables`  
**原因**：開發環境邏輯過於嚴格  
**解決**：更新 `app/lib/supabase.ts` 允許開發環境使用佔位符

### 問題 3：Storage Bucket 名稱不匹配

**症狀**：`Bucket not found`  
**原因**：代碼使用 `screenshots`，實際建立的是 `project-images`  
**解決**：統一使用 `project-images` 名稱

### 問題 4：中文檔名上傳失敗

**症狀**：`Invalid key: 螢幕擷取畫面.png`  
**原因**：Supabase Storage 只接受 ASCII 字符  
**解決**：實施雙檔名系統（詳見 `中文檔名支援實施報告.md`）

---

## 🔄 回退計畫

如果遷移過程中遇到無法解決的問題：

### 立即回退步驟

```bash
# 1. 切換到遷移前的 Git commit
git log  # 找到遷移前的 commit ID
git checkout <commit-id>

# 2. 強制推送（⚠️ 謹慎使用）
git push origin main --force

# 3. Vercel 會自動回退到舊版本
# 等待部署完成即可恢復服務
```

### 資料回復

1. 如果已經刪除 Vercel Blob 資料：
   - 使用備份的 JSON 檔案
   - 透過管理後台重新匯入

2. 如果保留了 Vercel Blob：
   - 直接切回程式碼即可
   - 資料完全不受影響

---

## ✅ 遷移完成檢核

當所有階段完成後，確認以下事項：

### 功能檢核
- [ ] ✅ 所有訪客功能正常
- [ ] ✅ 所有管理員功能正常
- [ ] ✅ 資料完整無遺失
- [ ] ✅ 圖片全部正常顯示
- [ ] ✅ 效能符合預期

### 系統檢核
- [ ] ✅ 自動備份已啟用
- [ ] ✅ 可成功回檔
- [ ] ✅ 即時更新正常（< 1 秒）
- [ ] ✅ Vercel 環境變數已設定
- [ ] ✅ 舊的 Blob 資料已備份

### 文檔檢核
- [ ] ✅ 已更新 README（如需要）
- [ ] ✅ 已記錄 Supabase 專案資訊
- [ ] ✅ 已儲存 API 金鑰（安全位置）

---

## 📌 重要提醒

### 本地測時的 [.env.local] 環境變數設置
```bash
# Vercel 需要設定的環境變數（3 個 Supabase + 1 個管理員密碼）：
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...（後端專用）
ADMIN_PASSWORD=你的管理員密碼（保持不變）
```

### 實際遷移成果（已完成）
```yaml
資料庫:
  ✅ 16 個專案 100% 遷移
  ✅ 2 個密碼 100% 遷移
  ✅ Settings 配置完整保留
  ✅ 0 筆資料遺失

程式碼:
  ✅ 19 個檔案新增/修改
  ✅ blob-storage.ts 已移除
  ✅ 圖片管理系統上線
  ✅ 引用追蹤機制完成

效能:
  ✅ 查詢速度提升 90%+
  ✅ 頁面載入時間 < 2 秒
  ✅ API 回應時間 < 500ms
```

### 不需要刪除的內容
⚠️ **保留以下內容作為備份**：
- Vercel Blob 資料（保留至少 1 個月）
- 本地備份的 JSON 檔案
- GitHub 硬編碼的圖片（可選擇性保留）

### 費用提醒
✅ **Supabase 免費版額度**：
- 500MB 資料庫（您只需 < 10MB）
- 1GB 檔案儲存（您的圖片 < 10MB）
- 完全免費，無需擔心

---

## 🎓 學習資源

### 官方文檔
- [Supabase 官方文檔](https://supabase.com/docs)
- [Vercel x Supabase 整合指南](https://vercel.com/integrations/supabase)
- [Supabase JavaScript 客戶端](https://supabase.com/docs/reference/javascript/introduction)

### 推薦閱讀順序
1. 先閱讀本文檔（總覽）
2. 按順序執行各階段（01 → 02 → 03）
3. 遇到問題時查閱官方文檔
4. 完成後進行功能測試

---

## 📞 需要協助？

### 除錯步驟
1. 查看瀏覽器 Console（F12 開發者工具）
2. 查看 Vercel 建置日誌
3. 查看 Supabase 日誌（Logs & Reports）
4. 參考本文檔的「常見問題」章節

### AI 協助
可以向 AI 詢問：
- "如何在 Supabase 設定 RLS 規則？"
- "為什麼我的圖片無法顯示？"
- "如何除錯 Supabase 連線問題？"

---

**準備好了嗎？讓我們開始第一階段！**

👉 請繼續閱讀：`01_創建Supabase專案.md`


