# 資料安全規則已啟用 ✅

## 📋 規則檔案位置

已在 `.cursor/rules/` 目錄下建立專門的資料安全防護規則：

- **主規則**: `.cursor/rules/資料安全與防護.mdc`
- **參考更新**: `.cursor/rules/最佳實踐與慣例.mdc`

## 🛡️ 規則內容概覽

### 核心防護原則

1. **永不自動覆寫生產資料**
   - 禁止在 GET 端點中自動初始化
   - 禁止在錯誤處理中靜默寫入
   - 禁止預設啟用 `forceWrite`

2. **讀取失敗必須拋出錯誤**
   - 區分「檔案不存在」和「讀取失敗」
   - 不在 catch 中返回預設資料
   - 讓調用者決定如何處理

3. **多層驗證保護**
   - 第一層：資料完整性驗證
   - 第二層：空資料保護檢查
   - 第三層：強制寫入安全鎖

### 包含的安全模式

✅ **推薦模式**：
- 讀取-修改-寫入模式
- 防禦性讀取
- 備份前寫入
- 重試機制

❌ **禁止模式**：
- 自動初始化端點
- 錯誤處理中的靜默寫入
- 無驗證的寫入端點
- 在 middleware 中寫入資料

### 詳細規範

- API 端點安全規範
- Vercel Blob 特定注意事項
- 代碼審查檢查清單
- 緊急情況處理流程

## 🤖 如何使用

### 1. Cursor AI 會自動遵循

當您在編寫涉及以下檔案類型的代碼時，Cursor AI 會自動應用這些規則：
- `app/lib/**/*.ts`
- `app/api/**/*.ts`
- `app/api/**/route.ts`

### 2. 手動提醒 AI

如果您想確保 AI 特別注意資料安全，可以使用以下提示：

```
請確保這段代碼遵循專案的資料安全與防護規則：
- 不要自動覆寫現有資料
- 讀取失敗時拋出錯誤
- 執行完整的三層驗證
```

### 3. 代碼審查

在審查涉及資料寫入的代碼時，參考規則中的檢查清單：
- 是否需要管理員授權？
- 是否有資料驗證？
- 錯誤處理是否安全？
- 是否記錄了詳細日誌？

## 📖 查看完整規則

在 Cursor 中打開以下檔案查看完整內容：
- `.cursor/rules/資料安全與防護.mdc`

或使用 Cursor 的規則面板查看。

## 🎯 規則的效果

### 防止的問題

✅ 防止資料在部署後被重置
✅ 防止讀取失敗時誤判為空資料
✅ 防止未授權的資料覆寫
✅ 防止在錯誤處理中靜默覆寫資料

### 確保的安全

✅ 所有寫入都有管理員授權
✅ 寫入前都有完整驗證
✅ 有詳細的操作日誌
✅ 危險操作有明確警告

## 🔄 規則維護

規則檔案應該：
- 隨專案演進更新
- 在發現新風險時補充
- 在代碼審查中引用
- 在 PR 中檢查遵守情況

## 💡 額外建議

### 定期備份
即使有規則保護，仍建議：
- 每週使用管理後台的「匯出資料」功能
- 重大變更前手動備份
- 保留多個歷史備份版本

### 監控與日誌
- 檢查 Vercel Functions 日誌
- 注意任何 `SAFETY_LOCK` 錯誤
- 監控資料寫入頻率

### 測試策略
- 在本地測試所有寫入操作
- 模擬讀取失敗情況
- 驗證錯誤處理邏輯
- 確認驗證機制有效

---

**建立日期**：2025-10-19
**適用範圍**：所有涉及 Vercel Blob 資料寫入的代碼
**優先級**：🔴 最高（違反可能導致資料永久丟失）

